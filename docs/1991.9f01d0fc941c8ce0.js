"use strict";var ue=Object.defineProperty,he=Object.defineProperties,pe=Object.getOwnPropertyDescriptors,B=Object.getOwnPropertySymbols,fe=Object.prototype.hasOwnProperty,de=Object.prototype.propertyIsEnumerable,J=(x,m,h)=>m in x?ue(x,m,{enumerable:!0,configurable:!0,writable:!0,value:h}):x[m]=h,R=(x,m)=>{for(var h in m||(m={}))fe.call(m,h)&&J(x,h,m[h]);if(B)for(var h of B(m))de.call(m,h)&&J(x,h,m[h]);return x},$=(x,m)=>he(x,pe(m));(self.webpackChunksite=self.webpackChunksite||[]).push([[1991],{1991:(x,m,h)=>{h.r(m),h.d(m,{ElevationQuery:()=>j,GeometryDescriptor:()=>g,default:()=>j,getFinestLodIndex:()=>F});var f=h(15861),K=h(59213),T=h(26584),y=h(62208),Z=h(10699),D=h(16730),C=h(72854),q=h(49672),X=h(55214),A=h(56741),w=h(65401),Y=(h(29132),h(8314),h(63290)),ee=h(33190),te=h(46367);const M=Y.Z.getLogger("esri.layers.support.ElevationSampler");class L{queryElevation(e){return function ne(c,e){const t=P(c,e.spatialReference);if(!t)return null;switch(c.type){case"point":!function se(c,e,t){c.z=(0,y.Pt)(t.elevationAt(e),0)}(c,t,e);break;case"polyline":!function le(c,e,t){E.spatialReference=e.spatialReference;const i=c.hasM&&!c.hasZ;for(let n=0;n<c.paths.length;n++){const l=c.paths[n],s=e.paths[n];for(let a=0;a<l.length;a++){const o=l[a],r=s[a];E.x=r[0],E.y=r[1],i&&(o[3]=o[2]),o[2]=(0,y.Pt)(t.elevationAt(E),0)}}c.hasZ=!0}(c,t,e);break;case"multipoint":!function oe(c,e,t){E.spatialReference=e.spatialReference;const i=c.hasM&&!c.hasZ;for(let n=0;n<c.points.length;n++){const l=c.points[n],s=e.points[n];E.x=s[0],E.y=s[1],i&&(l[3]=l[2]),l[2]=(0,y.Pt)(t.elevationAt(E),0)}c.hasZ=!0}(c,t,e)}return c}(e.clone(),this)}on(){return ae}projectIfRequired(e,t){return P(e,t)}}class ie extends L{constructor(e,t,i){super(),this.tile=e,this.noDataValue=i,this.extent=(0,w.HH)(e.tile.extent,t.spatialReference);const n=(0,D.c9)(t.spatialReference),l=t.lodAt(e.tile.level).resolution*n;this.demResolution={min:l,max:l}}get spatialReference(){return this.extent.spatialReference}contains(e){const t=this.projectIfRequired(e,this.spatialReference);return(0,ee.aV)(this.extent,t)}elevationAt(e){const t=this.projectIfRequired(e,this.spatialReference);if((0,y.Wi)(t))return null;if(!this.contains(e)){const i=this.extent;return M.warn("#elevationAt()",`Point used to sample elevation (${e.x}, ${e.y}) is outside of the sampler extent (${i.xmin}, ${i.ymin}, ${i.xmax}, ${i.ymax})`),this.noDataValue}return this.tile.sample(t.x,t.y)}}class O extends L{constructor(e,t,i){let n;super(),"number"==typeof t?(this.noDataValue=t,n=null):(n=t,this.noDataValue=i),this.samplers=n?e.map(s=>new ie(s,n,this.noDataValue)):e;const l=this.samplers[0];if(l){this.extent=l.extent.clone();const{min:s,max:a}=l.demResolution;this.demResolution={min:s,max:a};for(let o=1;o<this.samplers.length;o++){const r=this.samplers[o];this.extent.union(r.extent),this.demResolution.min=Math.min(this.demResolution.min,r.demResolution.min),this.demResolution.max=Math.max(this.demResolution.max,r.demResolution.max)}}else this.extent=(0,w.HH)((0,w.Ue)(),n.spatialReference),this.demResolution={min:0,max:0}}get spatialReference(){return this.extent.spatialReference}elevationAt(e){const t=this.projectIfRequired(e,this.spatialReference);if(!t)return null;for(const i of this.samplers)if(i.contains(t))return i.elevationAt(t);return M.warn("#elevationAt()",`Point used to sample elevation (${e.x}, ${e.y}) is outside of the sampler`),this.noDataValue}}function P(c,e){if((0,y.Wi)(c))return null;const t=c.spatialReference;if(t.equals(e))return c;const i=(0,te.iV)(c,e);return i||M.error(`Cannot project geometry spatial reference (wkid:${t.wkid}) to elevation sampler spatial reference (wkid:${e.wkid})`),i}const E=new q.Z,ae={remove(){}};class U{constructor(e,t=null){if(this.tile=e,(0,y.pC)(t)){const i=e.extent;this.samplerData={pixelData:t.values,width:t.width,height:t.height,safeWidth:.99999999*(t.width-1),noDataValue:t.noDataValue,dx:(t.width-1)/(i[2]-i[0]),dy:(t.width-1)/(i[3]-i[1]),x0:i[0],y1:i[3]}}}sample(e,t){if((0,y.Wi)(this.samplerData))return;const{safeWidth:i,width:n,pixelData:l,noDataValue:s,dx:a,dy:o,y1:r,x0:u}=this.samplerData,p=W(o*(r-t),0,i),d=W(a*(e-u),0,i),v=Math.floor(p),H=Math.floor(d),z=v*n+H,b=z+n,V=l[z],S=l[b],Q=l[z+1],k=l[b+1];if(V!==s&&S!==s&&Q!==s&&k!==s){const N=d-H,_=V+(Q-V)*N;return _+(S+(k-S)*N-_)*(p-v)}}}function W(c,e,t){return c<e?e:c>t?t:c}class j{queryAll(e,t,i){var n=this;return(0,f.Z)(function*(){if(!(e=i&&i.ignoreInvisibleLayers?e.filter(u=>u.visible):e.slice()).length)throw new T.Z("elevation-query:invalid-layer","Elevation queries require at least one elevation layer to fetch tiles from");const l=g.fromGeometry(t);let s=!1;i&&i.returnSampleInfo||(s=!0);const a=$(R(R({},I),i),{returnSampleInfo:!0}),o=yield n.query(e[e.length-1],l,a),r=yield n._queryAllContinue(e,o,a);return r.geometry=r.geometry.export(),s&&delete r.sampleInfo,r})()}query(e,t,i){var n=this;return(0,f.Z)(function*(){if(!e)throw new T.Z("elevation-query:invalid-layer","Elevation queries require an elevation layer to fetch tiles from");if(!t||!(t instanceof g)&&"point"!==t.type&&"multipoint"!==t.type&&"polyline"!==t.type)throw new T.Z("elevation-query:invalid-geometry","Only point, polyline and multipoint geometries can be used to query elevation");const l=R(R({},I),i),s=new re(e,t.spatialReference,l),a=l.signal;return yield e.load({signal:a}),yield n._createGeometryDescriptor(s,t,a),yield n._selectTiles(s,a),yield n._populateElevationTiles(s,a),n._sampleGeometryWithElevation(s),n._createQueryResult(s,a)})()}createSampler(e,t,i){var n=this;return(0,f.Z)(function*(){if(!e)throw new T.Z("elevation-query:invalid-layer","Elevation queries require an elevation layer to fetch tiles from");if(!t||"extent"!==t.type)throw new T.Z("elevation-query:invalid-extent","Invalid or undefined extent");const l=R(R({},I),i);return n._createSampler(e,t,l)})()}createSamplerAll(e,t,i){var n=this;return(0,f.Z)(function*(){if(!(e=i&&i.ignoreInvisibleLayers?e.filter(a=>a.visible):e.slice()).length)throw new T.Z("elevation-query:invalid-layer","Elevation queries require at least one elevation layer to fetch tiles from");if(!t||"extent"!==t.type)throw new T.Z("elevation-query:invalid-extent","Invalid or undefined extent");const l=$(R(R({},I),i),{returnSampleInfo:!0}),s=yield n._createSampler(e[e.length-1],t,l);return n._createSamplerAllContinue(e,t,s,l)})()}_createSampler(e,t,i,n){var l=this;return(0,f.Z)(function*(){const s=i.signal;yield e.load({signal:s});const a=t.spatialReference,o=e.tileInfo.spatialReference;a.equals(o)||(yield(0,A.iQ)([{source:a,dest:o}],{signal:s}),t=(0,A.iV)(t,o));const r=new ce(e,t,i,n);return yield l._selectTiles(r,s),yield l._populateElevationTiles(r,s),new O(r.elevationTiles,r.layer.tileInfo,r.options.noDataValue)})()}_createSamplerAllContinue(e,t,i,n){var l=this;return(0,f.Z)(function*(){if(e.pop(),!e.length)return i;const s=i.samplers.map(u=>(0,w.oJ)(u.extent)),a=yield l._createSampler(e[e.length-1],t,n,s);if(0===a.samplers.length)return i;const o=i.samplers.concat(a.samplers),r=new O(o,n.noDataValue);return l._createSamplerAllContinue(e,t,r,n)})()}_queryAllContinue(e,t,i){var n=this;return(0,f.Z)(function*(){const l=e.pop(),s=t.geometry.coordinates,a=[],o=[];for(let p=0;p<s.length;p++){const d=t.sampleInfo[p];d.demResolution>=0?d.source||(d.source=l):e.length&&(a.push(s[p]),o.push(p))}if(!e.length||0===a.length)return t;const r=t.geometry.clone(a),u=yield n.query(e[e.length-1],r,i);return o.forEach((p,d)=>{s[p].z=u.geometry.coordinates[d].z,t.sampleInfo[p].demResolution=u.sampleInfo[d].demResolution}),n._queryAllContinue(e,t,i)})()}_createQueryResult(e,t){var i=this;return(0,f.Z)(function*(){const n={geometry:(yield e.geometry.project(e.outSpatialReference,t)).export(),noDataValue:e.options.noDataValue};return e.options.returnSampleInfo&&(n.sampleInfo=i._extractSampleInfo(e)),e.geometry.coordinates.forEach(l=>{l.tile=null,l.elevationTile=null}),n})()}_createGeometryDescriptor(e,t,i){return(0,f.Z)(function*(){let n;const l=e.layer.tileInfo.spatialReference;if(t instanceof g?n=yield t.project(l,i):(yield(0,A.iQ)([{source:t.spatialReference,dest:l}],{signal:i}),n=(0,A.iV)(t,l)),!n)throw new T.Z("elevation-query:spatial-reference-mismatch",`Cannot query elevation in '${t.spatialReference.wkid}' on an elevation service in '${l.wkid}'`);e.geometry=g.fromGeometry(n)})()}_selectTiles(e,t){var i=this;return(0,f.Z)(function*(){const n=e.options.demResolution;if("geometry"===e.type&&i._preselectOutsideLayerExtent(e),"number"==typeof n)i._selectTilesClosestResolution(e);else if("finest-contiguous"===n)yield i._selectTilesFinestContiguous(e,t);else{if("auto"!==n)throw new T.Z("elevation-query:invalid-dem-resolution",`Invalid dem resolution value '${n}', expected a number, "finest-contiguous" or "auto"`);yield i._selectTilesAuto(e,t)}})()}_preselectOutsideLayerExtent(e){if((0,y.Wi)(e.layer.fullExtent))return;const t=new U(null);t.sample=()=>e.options.noDataValue,e.outsideExtentTile=t;const i=e.layer.fullExtent;e.geometry.coordinates.forEach(n=>{const l=n.x,s=n.y;(l<i.xmin||l>i.xmax||s<i.ymin||s>i.ymax)&&(n.elevationTile=t)})}_selectTilesClosestResolution(e){const i=this._findNearestDemResolutionLODIndex(e.layer.tileInfo,e.options.demResolution);e.selectTilesAtLOD(i)}_findNearestDemResolutionLODIndex(e,t){const i=t/(0,D.c9)(e.spatialReference);let n=e.lods[0],l=0;for(let s=1;s<e.lods.length;s++){const a=e.lods[s];Math.abs(a.resolution-i)<Math.abs(n.resolution-i)&&(n=a,l=s)}return l}_selectTilesFinestContiguous(e,t){var i=this;return(0,f.Z)(function*(){const n=F(e.layer.tileInfo,e.options.minDemResolution);yield i._selectTilesFinestContiguousAt(e,n,t)})()}_selectTilesFinestContiguousAt(e,t,i){var n=this;return(0,f.Z)(function*(){const l=e.layer;if(e.selectTilesAtLOD(t),t<0)return;const s=l.tilemapCache,a=e.getTilesToFetch();try{if(s)yield(0,Z.Hl)(Promise.all(a.map(o=>s.fetchAvailability(o.level,o.row,o.col,{signal:i}))),i);else if(yield n._populateElevationTiles(e,i),!e.allElevationTilesFetched())throw e.clearElevationTiles(),new T.Z("elevation-query:has-unavailable-tiles")}catch(o){(0,Z.r9)(o),yield n._selectTilesFinestContiguousAt(e,t-1,i)}})()}_populateElevationTiles(e,t){return(0,f.Z)(function*(){const i=e.getTilesToFetch(),n={},l=e.options.cache,s=e.options.noDataValue,a=i.map(function(){var o=(0,f.Z)(function*(r){const u=`${e.layer.uid}:${r.id}:${s}`,p=(0,y.pC)(l)?l.get(u):null,d=(0,y.pC)(p)?p:yield e.layer.fetchTile(r.level,r.row,r.col,{noDataValue:s,signal:t});(0,y.pC)(l)&&l.put(u,d),n[r.id]=new U(r,d)});return function(r){return o.apply(this,arguments)}}());yield(0,Z.Hl)((0,Z.as)(a),t),e.populateElevationTiles(n)})()}_selectTilesAuto(e,t){var i=this;return(0,f.Z)(function*(){i._selectTilesAutoFinest(e),i._reduceTilesForMaximumRequests(e);const n=e.layer.tilemapCache;if(!n)return i._selectTilesAutoPrefetchUpsample(e,t);const l=e.getTilesToFetch(),s={},a=l.map(function(){var o=(0,f.Z)(function*(r){const u={id:null,level:0,row:0,col:0,extent:(0,w.Ue)()},p=yield(0,K.q6)(n.fetchAvailabilityUpsample(r.level,r.row,r.col,u,{signal:t}));!1===p.ok?(0,Z.r9)(p.error):s[r.id]=u});return function(r){return o.apply(this,arguments)}}());yield(0,Z.Hl)(Promise.all(a),t),e.remapTiles(s)})()}_reduceTilesForMaximumRequests(e){const t=e.layer.tileInfo;let i=0;const n={},l=o=>{o.id in n?n[o.id]++:(n[o.id]=1,i++)},s=o=>{const r=n[o.id];1===r?(delete n[o.id],i--):n[o.id]=r-1};e.forEachTileToFetch(l,s);let a=!0;for(;a&&(a=!1,e.forEachTileToFetch(o=>{i<=e.options.maximumAutoTileRequests||(s(o),t.upsampleTile(o)&&(a=!0),l(o))},s),a););}_selectTilesAutoFinest(e){const t=F(e.layer.tileInfo,e.options.minDemResolution);e.selectTilesAtLOD(t,e.options.maximumAutoTileRequests)}_selectTilesAutoPrefetchUpsample(e,t){var i=this;return(0,f.Z)(function*(){const n=e.layer.tileInfo;yield i._populateElevationTiles(e,t);let l=!1;e.forEachTileToFetch((s,a)=>{n.upsampleTile(s)?l=!0:a()}),l&&(yield i._selectTilesAutoPrefetchUpsample(e,t))})()}_sampleGeometryWithElevation(e){e.geometry.coordinates.forEach(t=>{const i=t.elevationTile;let n=e.options.noDataValue;if(i){const l=i.sample(t.x,t.y);(0,y.pC)(l)?n=l:t.elevationTile=null}t.z=n})}_extractSampleInfo(e){const t=e.layer.tileInfo,i=(0,D.c9)(t.spatialReference);return e.geometry.coordinates.map(n=>{let l=-1;return n.elevationTile&&n.elevationTile!==e.outsideExtentTile&&(l=t.lodAt(n.elevationTile.tile.level).resolution*i),{demResolution:l}})}}class g{export(){return this._exporter(this.coordinates,this.spatialReference)}clone(e){const t=new g;return t.geometry=this.geometry,t.spatialReference=this.spatialReference,t.coordinates=e||this.coordinates.map(i=>this._cloneCoordinate(i)),t._exporter=this._exporter,t}project(e,t){var i=this;return(0,f.Z)(function*(){if(i.spatialReference.equals(e))return i.clone();yield(0,A.iQ)([{source:i.spatialReference,dest:e}],{signal:t});const n=new C.Z({spatialReference:i.spatialReference,points:i.coordinates.map(o=>[o.x,o.y])}),l=(0,A.iV)(n,e);if(!l)return null;const s=i.coordinates.map((o,r)=>{const u=i._cloneCoordinate(o),p=l.points[r];return u.x=p[0],u.y=p[1],u}),a=i.clone(s);return a.spatialReference=e,a})()}_cloneCoordinate(e){return{x:e.x,y:e.y,z:e.z,m:e.m,tile:null,elevationTile:null}}static fromGeometry(e){const t=new g;if(t.geometry=e,t.spatialReference=e.spatialReference,e instanceof g)t.coordinates=e.coordinates.map(i=>t._cloneCoordinate(i)),t._exporter=(i,n)=>{const l=e.clone(i);return l.spatialReference=n,l};else switch(e.type){case"point":{const i=e,{hasZ:n,hasM:l}=i;t.coordinates=n&&l?[{x:i.x,y:i.y,z:i.z,m:i.m}]:n?[{x:i.x,y:i.y,z:i.z}]:l?[{x:i.x,y:i.y,m:i.m}]:[{x:i.x,y:i.y}],t._exporter=(s,a)=>e.hasM?new q.Z(s[0].x,s[0].y,s[0].z,s[0].m,a):new q.Z(s[0].x,s[0].y,s[0].z,a);break}case"multipoint":{const i=e,{hasZ:n,hasM:l}=i;t.coordinates=i.points.map(n&&l?s=>({x:s[0],y:s[1],z:s[2],m:s[3]}):n?s=>({x:s[0],y:s[1],z:s[2]}):l?s=>({x:s[0],y:s[1],m:s[2]}):s=>({x:s[0],y:s[1]})),t._exporter=(s,a)=>e.hasM?new C.Z({points:s.map(o=>[o.x,o.y,o.z,o.m]),hasZ:!0,hasM:!0,spatiaReference:a}):new C.Z(s.map(o=>[o.x,o.y,o.z]),a);break}case"polyline":{const i=e,n=[],l=[],{hasZ:s,hasM:a}=e;let o=0;for(const r of i.paths)if(l.push([o,o+r.length]),o+=r.length,s&&a)for(const u of r)n.push({x:u[0],y:u[1],z:u[2],m:u[3]});else if(s)for(const u of r)n.push({x:u[0],y:u[1],z:u[2]});else if(a)for(const u of r)n.push({x:u[0],y:u[1],m:u[2]});else for(const u of r)n.push({x:u[0],y:u[1]});t.coordinates=n,t._exporter=(r,u)=>{const p=r.map(e.hasM?v=>[v.x,v.y,v.z,v.m]:v=>[v.x,v.y,v.z]),d=l.map(v=>p.slice(v[0],v[1]));return new X.Z({paths:d,hasM:e.hasM,hasZ:!0,spatialReference:u})};break}}return t}}class G{constructor(e,t){this.layer=e,this.options=t}}class re extends G{constructor(e,t,i){super(e,i),this.outSpatialReference=t,this.type="geometry"}selectTilesAtLOD(e){if(e<0)this.geometry.coordinates.forEach(t=>t.tile=null);else{const t=this.layer.tileInfo,i=t.lods[e].level;this.geometry.coordinates.forEach(n=>{n.tile=t.tileAt(i,n.x,n.y)})}}allElevationTilesFetched(){return!this.geometry.coordinates.some(e=>!e.elevationTile)}clearElevationTiles(){for(const e of this.geometry.coordinates)e.elevationTile!==this.outsideExtentTile&&(e.elevationTile=null)}populateElevationTiles(e){for(const t of this.geometry.coordinates)!t.elevationTile&&t.tile&&(t.elevationTile=e[t.tile.id])}remapTiles(e){for(const t of this.geometry.coordinates)t.tile=e[t.tile.id]}getTilesToFetch(){const e={},t=[];for(const i of this.geometry.coordinates){const n=i.tile;i.elevationTile||!i.tile||e[n.id]||(e[n.id]=n,t.push(n))}return t}forEachTileToFetch(e){for(const t of this.geometry.coordinates)t.tile&&!t.elevationTile&&e(t.tile,()=>t.tile=null)}}class ce extends G{constructor(e,t,i,n){super(e,i),this.type="extent",this.elevationTiles=[],this.candidateTiles=[],this.fetchedCandidates=new Set,this.extent=t.intersection(e.fullExtent),this.maskExtents=n}selectTilesAtLOD(e,t){const i=this._maximumLodForRequests(t),n=Math.min(i,e);n<0?this.candidateTiles.length=0:this._selectCandidateTilesCoveringExtentAt(n)}_maximumLodForRequests(e){const t=this.layer.tileInfo;if(!e)return t.lods.length-1;const i=this.extent;if((0,y.Wi)(i))return-1;for(let n=t.lods.length-1;n>=0;n--){const l=t.lods[n],a=l.resolution*t.size[1];if(Math.ceil(i.width/(l.resolution*t.size[0]))*Math.ceil(i.height/a)<=e)return n}return-1}allElevationTilesFetched(){return this.candidateTiles.length===this.elevationTiles.length}clearElevationTiles(){this.elevationTiles.length=0,this.fetchedCandidates.clear()}populateElevationTiles(e){for(const t of this.candidateTiles){const i=e[t.id];i&&(this.fetchedCandidates.add(t),this.elevationTiles.push(i))}}remapTiles(e){this.candidateTiles=this._uniqueNonOverlappingTiles(this.candidateTiles.map(t=>e[t.id]))}getTilesToFetch(){return this.candidateTiles}forEachTileToFetch(e,t){const i=this.candidateTiles;this.candidateTiles=[],i.forEach(n=>{if(this.fetchedCandidates.has(n))return void(t&&t(n));let l=!1;e(n,()=>l=!0),l?t&&t(n):this.candidateTiles.push(n)}),this.candidateTiles=this._uniqueNonOverlappingTiles(this.candidateTiles,t)}_uniqueNonOverlappingTiles(e,t){const i={},n=[];for(const s of e)i[s.id]?t&&t(s):(i[s.id]=s,n.push(s));const l=n.sort((s,a)=>s.level-a.level);return l.filter((s,a)=>{for(let o=0;o<a;o++)if((0,w.r3)(l[o].extent,s.extent))return t&&t(s),!1;return!0})}_selectCandidateTilesCoveringExtentAt(e){this.candidateTiles.length=0;const t=this.extent;if((0,y.Wi)(t))return;const i=this.layer.tileInfo,n=i.lods[e],l=i.tileAt(n.level,t.xmin,t.ymin),a=n.resolution*i.size[1],o=Math.ceil((t.xmax-l.extent[0])/(n.resolution*i.size[0])),r=Math.ceil((t.ymax-l.extent[1])/a);for(let u=0;u<r;u++)for(let p=0;p<o;p++){const d={id:null,level:l.level,row:l.row-u,col:l.col+p};i.updateTileInfo(d),this._tileIsMasked(d)||this.candidateTiles.push(d)}}_tileIsMasked(e){return!!this.maskExtents&&this.maskExtents.some(t=>(0,w.r3)(t,e.extent))}}function F(c,e){let t=c.lods.length-1;if(e>0){const i=c.lods.findIndex(n=>n.resolution<e);0===i?t=0:i>0&&(t=i-1)}return t}const I={maximumAutoTileRequests:20,noDataValue:0,returnSampleInfo:!1,demResolution:"auto",minDemResolution:0}}}]);