"use strict";var Be=Object.defineProperty,Ae=Object.defineProperties,Le=Object.getOwnPropertyDescriptors,fe=Object.getOwnPropertySymbols,Ne=Object.prototype.hasOwnProperty,je=Object.prototype.propertyIsEnumerable,pe=(J,W,w)=>W in J?Be(J,W,{enumerable:!0,configurable:!0,writable:!0,value:w}):J[W]=w,re=(J,W)=>{for(var w in W||(W={}))Ne.call(W,w)&&pe(J,w,W[w]);if(fe)for(var w of fe(W))je.call(W,w)&&pe(J,w,W[w]);return J},oe=(J,W)=>Ae(J,Le(W));(self.webpackChunksite=self.webpackChunksite||[]).push([[5171],{90512:(J,W,w)=>{w.d(W,{Z:()=>U});var q=w(10699);class U{constructor(){this.declaredRootClass="esri.arcade.featureSetCollection",this._layerById={},this._layerByName={}}add(R,T,P){this._layerById[T]=P,this._layerByName[R]=P}featureSetByName(R,T=!0,P=["*"]){return this.resolvePromise(void 0===this._layerByName[R]?null:this._layerByName[R])}featureSetById(R,T=!0,P=["*"]){return this.resolvePromise(void 0===this._layerById[R]?null:this._layerById[R])}castToText(){return"object, FeatureSetCollection"}resolvePromise(R){return(0,q.DB)(R)}}},85171:(J,W,w)=>{w.r(W),w.d(W,{constructAssociationMetaDataFeatureSetFromUrl:()=>be,constructFeatureSet:()=>ee,constructFeatureSetFromPortalItem:()=>Oe,constructFeatureSetFromRelationship:()=>Ce,constructFeatureSetFromUrl:()=>ae,convertToFeatureSet:()=>xe,createFeatureSetCollectionFromMap:()=>Ee,createFeatureSetCollectionFromService:()=>Re,getPortal:()=>Te,initialiseMetaDataCache:()=>we,lookupUser:()=>Pe});var q=w(24263),U=w(84792),k=w(90512),R=w(53997),T=w(88879),P=w(47562),I=w(52724),D=w(95896),L=w(49086),_=w(91510),S=w(57366),y=w(77132),v=w(83947),p=w(45333),b=w(10410);class l{clone(){const e=new l;return e.field=this.field,e.tofieldname=this.tofieldname,e.typeofstat=this.typeofstat,e.workingexpr=this.workingexpr,e}static parseStatField(e,t,s){const i=new l;i.field=e;const d=b.WhereClause.create(t,s),n=function g(C){if("function"===C.parseTree.type){if(0===C.parseTree.args.value.length)return{name:C.parseTree.name,expr:null};if(C.parseTree.args.value.length>1)throw new Error("Statistic does not have 1 or 0 Parameters");const e=b.WhereClause.create((0,v.XF)(C.parseTree.args.value[0],y.Bj.Standardised,C.parameters),C.fieldsIndex);return{name:C.parseTree.name,expr:e}}return null}(d);if(null===n)throw new Error("Invalid Statistic Function");const a=n.name.toUpperCase().trim();if("MIN"===a){if(i.typeofstat="MIN",i.workingexpr=n.expr,null===d)throw new Error("Invalid Statistic Function Parameters")}else if("MAX"===a){if(i.typeofstat="MAX",i.workingexpr=n.expr,null===d)throw new Error("Invalid Statistic Function Parameters")}else if("COUNT"===a)i.typeofstat="COUNT",i.workingexpr=n.expr;else if("STDEV"===a){if(i.typeofstat="STDDEV",i.workingexpr=n.expr,null===d)throw new Error("Invalid Statistic Function Parameters")}else if("SUM"===a){if(i.typeofstat="SUM",i.workingexpr=n.expr,null===d)throw new Error("Invalid Statistic Function Parameters")}else if("MEAN"===a){if(i.typeofstat="AVG",i.workingexpr=n.expr,null===d)throw new Error("Invalid Statistic Function Parameters")}else if("AVG"===a){if(i.typeofstat="AVG",i.workingexpr=n.expr,null===d)throw new Error("Invalid Statistic Function Parameters")}else{if("VAR"!==a)throw new Error("Invalid Statistic Function");if(i.typeofstat="VAR",i.workingexpr=n.expr,null===d)throw new Error("Invalid Statistic Function Parameters")}return i}toStatisticsName(){switch(this.typeofstat.toUpperCase()){case"MIN":return"min";case"MAX":return"max";case"SUM":return"sum";case"COUNT":default:return"count";case"VAR":return"var";case"STDDEV":return"stddev";case"AVG":return"avg"}}}var u=w(50011),r=w(10699),o=w(65234),h=w(36255),c=w(60466);function m(C){if(!C)return"COUNT";switch(C.toLowerCase()){case"max":return"MAX";case"var":case"variance":return"VAR";case"avg":case"average":case"mean":return"AVG";case"min":return"MIN";case"sum":return"SUM";case"stdev":case"stddev":return"STDDEV";case"count":return"COUNT"}return"COUNT"}class j extends L.Z{constructor(e){super(e),this._decodedStatsfield=[],this._decodedGroupbyfield=[],this._candosimplegroupby=!0,this.phsyicalgroupbyfields=[],this.objectIdField="ROW__ID",this._internalObjectIdField="ROW__ID",this._adaptedFields=[],this.declaredClass="esri.arcade.featureset.actions.Aggregate",this._uniqueIds=1,this._maxQuery=10,this._maxProcessing=10,this._parent=e.parentfeatureset,this._config=e}isTable(){return!0}_getSet(e){return null===this._wset?this._getFilteredSet("",null,null,null,e).then(t=>(this._wset=t,this._wset)):(0,r.DB)(this._wset)}_isInFeatureSet(){return y.dj.InFeatureSet}nextUniqueName(e){for(;1===e["T"+this._uniqueIds.toString()];)this._uniqueIds++;const t="T"+this._uniqueIds.toString();return e[t]=1,t}convertToEsriFieldType(e){return e}_initialiseFeatureSet(){const e={};let t=!1,s=1;const i=this._parent?this._parent.getFieldsIndex():new c.Z([]);for(this.objectIdField="ROW__ID",this.globalIdField="";!1===t;){let n=!1;for(let a=0;a<this._config.groupbyfields.length;a++)if(this._config.groupbyfields[a].name.toLowerCase()===this.objectIdField.toLowerCase()){n=!0;break}if(!1===n)for(let a=0;a<this._config.statsfields.length;a++)if(this._config.statsfields[a].name.toLowerCase()===this.objectIdField.toLowerCase()){n=!0;break}!1===n?t=!0:(this.objectIdField="ROW__ID"+s.toString(),s++)}for(const n of this._config.statsfields){const a=new l;a.field=n.name,a.tofieldname=n.name,a.workingexpr=n.expression instanceof b.WhereClause?n.expression:b.WhereClause.create(n.expression,i),a.typeofstat=m(n.statistic),this._decodedStatsfield.push(a)}this._decodedGroupbyfield=[];for(const n of this._config.groupbyfields){const a={name:n.name,singlefield:null,tofieldname:n.name,expression:n.expression instanceof b.WhereClause?n.expression:b.WhereClause.create(n.expression,i)};this._decodedGroupbyfield.push(a)}if(null!==this._parent){this.geometryType=this._parent.geometryType,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField="";for(const n of this._parent.fields)e[n.name.toUpperCase()]=1;this.types=null}else this.geometryType=y.Qk.point,this.typeIdField="",this.types=null,this.spatialReference=new o.Z({wkid:4326});this.fields=[];const d=new l;d.field=this.nextUniqueName(e),d.tofieldname=this.objectIdField,d.workingexpr=b.WhereClause.create(this._parent.objectIdField,this._parent.getFieldsIndex()),d.typeofstat="MIN",this._decodedStatsfield.push(d);for(const n of this._decodedGroupbyfield){const a=new h.Z;if(n.name=this.nextUniqueName(e),a.name=n.tofieldname,a.alias=a.name,(0,v.y5)(n.expression)){const f=this._parent.getField((0,v.zR)(n.expression,y.Bj.Standardised));if(!f)throw new Error("Field is not present for Aggregation");n.name=f.name,n.singlefield=f.name,this.phsyicalgroupbyfields.push(f.name),a.type=f.type}else{a.type=this.convertToEsriFieldType((0,v.DT)(n.expression,this._parent.fields));const f=new h.Z;f.name=n.name,f.alias=f.name,this.phsyicalgroupbyfields.push(n.name),this._adaptedFields.push(new I.yN(f,n.expression)),this._candosimplegroupby=!1}this.fields.push(a)}if(this._adaptedFields.length>0)for(const n of this._parent.fields)this._adaptedFields.push(new I.$X(n));for(let n=0;n<this._decodedStatsfield.length;n++){const a=new h.Z;let f=null;const F=this._decodedStatsfield[n];F.field=this.nextUniqueName(e),F.tofieldname===this.objectIdField&&(this._internalObjectIdField=F.field),a.name=F.tofieldname,a.alias=a.name;const E=null!==F.workingexpr&&(0,v.y5)(F.workingexpr)?(0,v.zR)(F.workingexpr,y.Bj.Standardised):"";switch(this._decodedStatsfield[n].typeofstat){case"SUM":if(""!==E){if(f=this._parent.getField(E),!f)throw new Error("Field is not present for Aggregation");a.type=f.type}else a.type="double";break;case"MIN":case"MAX":if(""!==E){if(f=this._parent.getField(E),!f)throw new Error("Field is not present for Aggregation");a.type=f.type}else a.type="double";break;case"COUNT":a.type="integer";break;case"STDDEV":case"VAR":case"AVG":if(""!==E&&(f=this._parent.getField(E),!f))throw new Error("Field is not present for Aggregation");a.type="double"}this.fields.push(a)}}_canDoAggregates(){return(0,r.DB)(!1)}_getFeatures(e,t,s,i){const d=this._maxQuery;return!0===this._checkIfNeedToExpandKnownPage(e,d)?this._expandPagedSet(e,d,0,0,i).then(()=>this._getFeatures(e,t,s,i)):(0,r.DB)("success")}_getFilteredSet(e,t,s,i,d){if(""!==e)return(0,r.DB)(new _.Z([],[],!0,null));let n=null;const a={ordered:!1,nowhereclause:!1};return this._ensureLoaded().then(()=>{if(null!==s)for(let f=0;f<this._decodedStatsfield.length;f++)if(!0===(0,v.hq)(s,this._decodedStatsfield[f].tofieldname)){a.nowhereclause=!0,s=null;break}if(null!==i){a.ordered=!0;for(let f=0;f<this._decodedStatsfield.length;f++)if(!0===i.scanForField(this._decodedStatsfield[f].tofieldname)){i=null,a.ordered=!1;break}if(null!==i)for(const f of this._decodedGroupbyfield)if(null===f.singlefield&&!0===i.scanForField(f.tofieldname)){i=null,a.ordered=!1;break}}return!1===this._candosimplegroupby?(0,r.DB)(!1):this._parent._canDoAggregates(this.phsyicalgroupbyfields,this._decodedStatsfield,"",null,null)}).then(f=>{if(f){let E=null;s&&(E=this._reformulateWhereClauseWithoutGroupByFields(s));let N=null;return i&&(N=this._reformulateOrderClauseWithoutGroupByFields(i)),this._parent._getAggregatePagesDataSourceDefinition(this.phsyicalgroupbyfields,this._decodedStatsfield,"",null,E,N,this._internalObjectIdField).then(O=>(this._checkCancelled(d),n=!0===a.nowhereclause?new _.Z(O._candidates.slice(0).concat(O._known.slice(0)),[],!0===a.ordered&&O._ordered,this._clonePageDefinition(O.pagesDefinition)):new _.Z(O._candidates.slice(0),O._known.slice(0),!0===a.ordered&&O._ordered,this._clonePageDefinition(O.pagesDefinition)),n))}let F=this._parent;if(this._adaptedFields.length>0&&(F=new I.Xx({parentfeatureset:this._parent,adaptedFields:this._adaptedFields,extraFilter:null})),!0===a.nowhereclause)n=new _.Z(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:this._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new D.Z({parentfeatureset:F,orderbyclause:new S.Z(this.phsyicalgroupbyfields.join(",")+","+this._parent.objectIdField+" ASC")})}});else{let E=F;if(null!==s){let N=null;s&&(N=this._reformulateWhereClauseWithoutGroupByFields(s)),E=new R.Z({parentfeatureset:E,whereclause:N})}n=new _.Z(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:this._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new D.Z({parentfeatureset:E,orderbyclause:new S.Z(this.phsyicalgroupbyfields.join(",")+","+this._parent.objectIdField+" ASC")})}})}return n})}_reformulateWhereClauseWithoutStatsFields(e){for(const t of this._decodedStatsfield)e=(0,v.bB)(e,t.tofieldname,(0,v.zR)(t.workingexpr,y.Bj.Standardised),this._parent.getFieldsIndex());return e}_reformulateWhereClauseWithoutGroupByFields(e){for(const t of this._decodedGroupbyfield)t.tofieldname!==t.name&&(e=(0,v.bB)(e,t.tofieldname,(0,v.zR)(t.expression,y.Bj.Standardised),this._parent.getFieldsIndex()));return e}_reformulateOrderClauseWithoutGroupByFields(e){const t=[];for(const s of this._decodedGroupbyfield)s.tofieldname!==s.name&&t.push({field:s.tofieldname,newfield:s.name});return t.length>0?e.replaceFields(t):e}_clonePageDefinition(e){return null===e?null:!0===e.aggregatefeaturesetpagedefinition?{aggregatefeaturesetpagedefinition:!0,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,internal:e.internal}:this._parent._clonePageDefinition(e)}_refineSetBlock(e,t,s){try{return!0===this._checkIfNeedToExpandCandidatePage(e,this._maxQuery)?this._expandPagedSet(e,this._maxQuery,0,0,s).then(()=>this._refineSetBlock(e,t,s)):(this._checkCancelled(s),this._refineKnowns(e,t),(0,r.DB)(e))}catch(i){return(0,r.d1)(i)}}_expandPagedSet(e,t,s,i,d){return this._expandPagedSetFeatureSet(e,t,s,i,d)}_getPhysicalPage(e,t,s){return!0===e.pagesDefinition.aggregatefeaturesetpagedefinition?(0,r.Ue)((i,d)=>{this._sequentialGetPhysicalItem(e,e.pagesDefinition.resultRecordCount,s,[]).then(n=>{i(n)},d)}):this._getAgregagtePhysicalPage(e,t,s).then(i=>{for(const d of i){const n={geometry:d.geometry,attributes:{}};for(const a of this._decodedGroupbyfield)n.attributes[a.tofieldname]=d.attributes[a.name];for(const a of this._decodedStatsfield)n.attributes[a.tofieldname]=d.attributes[a.field];this._featureCache[n.attributes[this.objectIdField]]=new T.Z(n)}return i.length})}_sequentialGetPhysicalItem(e,t,s,i){return(0,r.Ue)((d,n)=>{null===e.pagesDefinition.internal.iterator&&(e.pagesDefinition.internal.iterator=e.pagesDefinition.internal.subfeatureset.iterator(s)),!0===e.pagesDefinition.internal.fullyResolved||0===t?d(i.length):this._nextAggregateItem(e,t,s,i,a=>{d(null===a?i.length:this._sequentialGetPhysicalItem(e,t-=1,s,i))},n)})}_nextAggregateItem(e,t,s,i,d,n){try{(0,P.U)(e.pagesDefinition.internal.iterator.next()).then(a=>{if(null===a)if(null!==e.pagesDefinition.internal.workingItem){const f=this._calculateAndAppendAggregateItem(e.pagesDefinition.internal.workingItem);i.push(f),e.pagesDefinition.internal.workingItem=null,e.pagesDefinition.internal.set.push(f.attributes[this.objectIdField]),e.pagesDefinition.internal.fullyResolved=!0,d(null)}else e.pagesDefinition.internal.fullyResolved=!0,d(null);else{const f=this._generateAggregateHash(a);if(null===e.pagesDefinition.internal.workingItem)e.pagesDefinition.internal.workingItem={features:[a],id:f};else{if(f!==e.pagesDefinition.internal.workingItem.id){const F=this._calculateAndAppendAggregateItem(e.pagesDefinition.internal.workingItem);return i.push(F),e.pagesDefinition.internal.workingItem=null,e.pagesDefinition.internal.set.push(F.attributes[this.objectIdField]),t-=1,e.pagesDefinition.internal.workingItem={features:[a],id:f},void d(F)}e.pagesDefinition.internal.workingItem.features.push(a)}this._nextAggregateItem(e,t,s,i,d,n)}},n)}catch(a){n(a)}}_calculateFieldStat(e,t,s){const i=[];for(let d=0;d<e.features.length;d++)if(null!==t.workingexpr){const n=t.workingexpr.calculateValue(e.features[d]);null!==n&&i.push(n)}else i.push(null);switch(t.typeofstat){case"MIN":s.attributes[t.tofieldname]=(0,p.tj)("min",i,-1);break;case"MAX":s.attributes[t.tofieldname]=(0,p.tj)("max",i,-1);break;case"SUM":s.attributes[t.tofieldname]=(0,p.tj)("sum",i,-1);break;case"COUNT":s.attributes[t.tofieldname]=i.length;break;case"VAR":s.attributes[t.tofieldname]=(0,p.tj)("var",i,-1);break;case"STDDEV":s.attributes[t.tofieldname]=(0,p.tj)("stddev",i,-1);break;case"AVG":s.attributes[t.tofieldname]=(0,p.tj)("avg",i,-1)}return!0}_calculateAndAppendAggregateItem(e){const t={attributes:{},geometry:null};for(const i of this._decodedGroupbyfield){const d=i.singlefield?e.features[0].attributes[i.singlefield]:i.expression.calculateValue(e.features[0]);t.attributes[i.tofieldname]=d}for(const i of this._decodedStatsfield)this._calculateFieldStat(e,i,t);const s=[];for(let i=0;i<this._decodedStatsfield.length;i++)s.push(this._calculateFieldStat(e,this._decodedStatsfield[i],t));return this._featureCache[t.attributes[this.objectIdField]]=new T.Z({attributes:t.attributes,geometry:t.geometry}),t}_generateAggregateHash(e){let t="";for(const s of this._decodedGroupbyfield){const i=s.singlefield?e.attributes[s.singlefield]:s.expression.calculateValue(e);t+=null==i?":":":"+i.toString()}return(0,u.F)(t,u.M.String)}_stat(){return(0,r.DB)({calculated:!1})}getFeatureByObjectId(){return(0,r.DB)(null)}static registerAction(){L.Z._featuresetFunctions.groupby=function(e,t){return new j({parentfeatureset:this,groupbyfields:e,statsfields:t})}}}var A=w(3482),B=w(79429),x=w(22386),K=w(91179),Z=w(15382),te=w(82054),$=w(98558),ie=w(17253),H=w(84952),ue=w(60776),de=w(4728),_e=w(20477),ye=w(6729);class se extends L.Z{constructor(e){super(e),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerDynamic",this._removeGeometry=!1,this._overrideFields=null,this.formulaCredential=null,this._pageJustIds=!1,this._requestStandardised=!1,this._useDefinitionExpression=!0,e.spatialReference&&(this.spatialReference=e.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=e.layer,this._wset=null,void 0!==e.outFields&&(this._overrideFields=e.outFields),void 0!==e.includeGeometry&&(this._removeGeometry=!1===e.includeGeometry)}_maxQueryRate(){return y.tI}end(){return this._layer}optimisePagingFeatureQueries(e){this._pageJustIds=e}convertQueryToLruCacheKey(e){const t=(0,y.hd)(e.toJSON());return(0,u.F)(t,u.M.String)}load(){return null===this._loadPromise&&(this._loadPromise=(0,r.Ue)((e,t)=>{try{if(!0===this._layer.loaded)return this._initialiseFeatureSet(),void e(this);this._layer.when().then(()=>{try{this._initialiseFeatureSet(),e(this)}catch(s){t(s)}},t),this._layer.load()}catch(s){t(s)}})),this._loadPromise}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this._layer.outFields&&(1!==this._layer.outFields.length||"*"!==this._layer.outFields[0])){const e=[];for(const t of this.fields)if("oid"===t.type)e.push(t);else for(const s of this._layer.outFields)if(s.toLowerCase()===t.name.toLowerCase()){e.push(t);break}this.fields=e}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const e=[],t=[];for(const s of this.fields)if("oid"===s.type)e.push(s),t.push(s.name);else for(const i of this._overrideFields)if(i.toLowerCase()===s.name.toLowerCase()){e.push(s),t.push(s.name);break}this.fields=e,this._overrideFields=t}if(this._layer.source&&this._layer.source.sourceJSON){const e=this._layer.source.sourceJSON.currentVersion;!0===this._layer.source.sourceJSON.useStandardizedQueries?(this._databaseType=y.Bj.StandardisedNoInterval,null!=e&&e>=10.61&&(this._databaseType=y.Bj.Standardised)):null!=e&&(e>=10.5&&(this._databaseType=y.Bj.StandardisedNoInterval,this._requestStandardised=!0),e>=10.61&&(this._databaseType=y.Bj.Standardised))}this.objectIdField=this._layer.objectIdField;for(const e of this.fields)"global-id"===e.type&&(this.globalIdField=e.name);this.hasM=this._layer.supportsM,this.hasZ=this._layer.supportsZ,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types}_isInFeatureSet(){return y.dj.InFeatureSet}_refineSetBlock(e){return(0,r.DB)(e)}_candidateIdTransform(e){return e}_getSet(e){return null===this._wset?this._ensureLoaded().then(()=>this._getFilteredSet("",null,null,null,e)).then(t=>(this._wset=t,t)):(0,r.DB)(this._wset)}_runDatabaseProbe(e){return(0,r.Ue)((t,s)=>{try{this._ensureLoaded().then(()=>{try{const i=new H.Z;i.where=e.replace("OBJECTID",this._layer.objectIdField),this._layer.queryObjectIds(i).then(()=>{t(!0)},()=>{try{t(!1)}catch(d){s(d)}})}catch(i){s(i)}})}catch(i){s(i)}})}_canUsePagination(){return!(!this._layer.capabilities||!this._layer.capabilities.query||!0!==this._layer.capabilities.query.supportsPagination)}_cacheableFeatureSetSourceKey(){return this._layer.url}pbfSupportedForQuery(e){return!e.outStatistics&&this._layer&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsFormatPBF&&!0===this._layer.capabilities.query.supportsQuantizationEditMode}queryPBF(e){return e.quantizationParameters={mode:"edit"},(0,_e.executeQueryPBF)(this._layer.parsedUrl,e,new $.J({})).then(t=>ie.default.fromJSON((0,te.cn)(t.data)).unquantize())}get gdbVersion(){return this._layer&&this._layer.capabilities&&this._layer.capabilities.data&&this._layer.capabilities.data.isVersioned?this._layer.gdbVersion?this._layer.gdbVersion:"SDE.DEFAULT":""}nativeCapabilities(){return{title:this._layer.title,source:this,canQueryRelated:!0,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:this._requestStandardised}}executeQuery(e,t){const s=new de.Z({url:this._layer.parsedUrl.path}),i="execute"===t&&this.pbfSupportedForQuery(e);let d=null;if(this.recentlyUsedQueries){const n=this.convertQueryToLruCacheKey(e);d=this.recentlyUsedQueries.getFromCache(n),null===d&&(d=!0!==i?s[t](e):this.queryPBF(e),this.recentlyUsedQueries.addToCache(n,d),d=d.catch(a=>{throw this.recentlyUsedQueries.removeFromCache(n),a}))}return this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:e,method:t}),null===d&&(d=!0!==i?s[t](e):this.queryPBF(e)),d}_getFilteredSet(e,t,s,i,d){return this.databaseType().then(n=>{if(this.isTable()&&t&&null!==e&&""!==e)return new _.Z([],[],!0,null);if(this._canUsePagination())return this._getFilteredSetUsingPaging(e,t,s,i,d);let a="",f=!1;null!==i&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(a=i.constructClause(),f=!0);const F=new H.Z;return F.where=null===s?null===t?"1=1":"":(0,v.zR)(s,n),this._requestStandardised&&(F.sqlFormat="standard"),F.spatialRelationship=this._makeRelationshipEnum(e),F.outSpatialReference=this.spatialReference,F.orderByFields=""!==a?a.split(","):null,F.geometry=null===t?null:t,F.relationParameter=this._makeRelationshipParam(e),this.executeQuery(F,"executeForIds").then(E=>(null===E&&(E=[]),this._checkCancelled(d),new _.Z([],E,f,null)))})}_expandPagedSet(e,t,s,i,d){return this._expandPagedSetFeatureSet(e,t,s,i,d)}_getFilteredSetUsingPaging(e,t,s,i,d){try{let n="",a=!1;return null!==i&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(n=i.constructClause(),a=!0),this.databaseType().then(f=>{let F=null===s?null===t?"1=1":"":(0,v.zR)(s,f);this._layer.definitionExpression&&this._useDefinitionExpression&&(F=""!==F?"(("+this._layer.definitionExpression+") AND ("+F+"))":this._layer.definitionExpression);let E=this._maxQueryRate();const N=this._layer.capabilities.query.maxRecordCount;void 0!==N&&N<E&&(E=N);let O=null;if(!0===this._pageJustIds)O=new _.Z([],["GETPAGES"],a,{spatialRel:this._makeRelationshipEnum(e),relationParam:this._makeRelationshipParam(e),outFields:this._layer.objectIdField,resultRecordCount:E,resultOffset:0,geometry:null===t?null:t,where:F,orderByFields:n,returnGeometry:!1,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}});else{let V=!0;!0===this._removeGeometry&&(V=!1);const G=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._layer.outFields?this._layer.outFields:["*"]);O=new _.Z([],["GETPAGES"],a,{spatialRel:this._makeRelationshipEnum(e),relationParam:this._makeRelationshipParam(e),outFields:G.join(","),resultRecordCount:E,resultOffset:0,geometry:null===t?null:t,where:F,orderByFields:n,returnGeometry:V,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}return this._expandPagedSet(O,E,0,1,d).then(()=>O)})}catch(n){return(0,r.d1)(n)}}_clonePageDefinition(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}}_getPhysicalPage(e,t,s){try{const i=e.pagesDefinition.internal.lastRetrieved,d=i,n=e.pagesDefinition.internal.lastPage,a=new H.Z;return this._requestStandardised&&(a.sqlFormat="standard"),a.spatialRelationship=e.pagesDefinition.spatialRel,a.relationParameter=e.pagesDefinition.relationParam,a.outFields=e.pagesDefinition.outFields.split(","),a.num=e.pagesDefinition.resultRecordCount,a.start=e.pagesDefinition.internal.lastPage,a.geometry=e.pagesDefinition.geometry,a.where=e.pagesDefinition.where,a.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,a.returnGeometry=e.pagesDefinition.returnGeometry,a.outSpatialReference=this.spatialReference,this.executeQuery(a,"execute").then(f=>{if(this._checkCancelled(s),e.pagesDefinition.internal.lastPage!==n)return"done";for(let F=0;F<f.features.length;F++)e.pagesDefinition.internal.set[d+F]=f.features[F].attributes[this._layer.objectIdField];if(!1===this._pageJustIds)for(let F=0;F<f.features.length;F++)this._featureCache[f.features[F].attributes[this._layer.objectIdField]]=f.features[F];return(void 0===f.exceededTransferLimit&&f.features.length!==e.pagesDefinition.resultRecordCount||!1===f.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=i+f.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,"done"})}catch(i){return(0,r.d1)(i)}}_fieldsIncludingObjectId(e){if(null===e)return[this.objectIdField];const t=e.slice(0);if(t.indexOf("*")>-1)return t;let s=!1;for(const i of t)if(i.toUpperCase()===this.objectIdField.toUpperCase()){s=!0;break}return!1===s&&t.push(this.objectIdField),t}_getFeatures(e,t,s,i){const d=[];try{if(-1!==t&&void 0===this._featureCache[t]&&d.push(t),!0===this._checkIfNeedToExpandKnownPage(e,this._maxProcessingRate()))return this._expandPagedSet(e,this._maxProcessingRate(),0,0,i).then(()=>this._getFeatures(e,t,s,i));let n=0;for(let a=e._lastFetchedIndex;a<e._known.length;a++){if(e._lastFetchedIndex+=1,n++,void 0===this._featureCache[e._known[a]]){let f=!1;if(null!=this._layer._mode){const F=this._layer._mode;if(void 0!==F._featureMap[e._known[a]]){const E=F._featureMap[e._known[a]];null!==E&&(f=!0,this._featureCache[e._known[a]]=E)}}if(!1===f&&(e._known[a]!==t&&d.push(e._known[a]),d.length>=this._maxProcessingRate()-1))break}if(n>=s&&0===d.length)break}if(0===d.length)return(0,r.DB)("success");try{const a=new H.Z;return this._requestStandardised&&(a.sqlFormat="standard"),a.objectIds=d,a.outFields=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._layer.outFields?this._layer.outFields:["*"]),a.returnGeometry=!0,!0===this._removeGeometry&&(a.returnGeometry=!1),a.outSpatialReference=this.spatialReference,this.executeQuery(a,"execute").then(f=>{if(this._checkCancelled(i),void 0!==f.error)return(0,r.d1)(new Error(f.error));for(let F=0;F<f.features.length;F++)this._featureCache[f.features[F].attributes[this._layer.objectIdField]]=f.features[F];return"success"})}catch(a){return(0,r.d1)(a)}}catch(n){return(0,r.d1)(n)}}_getDistinctPages(e,t,s,i,d,n,a,f,F){return this._ensureLoaded().then(()=>this.databaseType()).then(E=>{let N=s.parseTree.column;for(let G=0;G<this._layer.fields.length;G++)if(this._layer.fields[G].name.toLowerCase()===N.toLowerCase()){N=this._layer.fields[G].name;break}const O=new H.Z;this._requestStandardised&&(O.sqlFormat="standard");let V=null===n?null===d?"1=1":"":(0,v.zR)(n,E);return this._layer.definitionExpression&&this._useDefinitionExpression&&(V=""!==V?"(("+this._layer.definitionExpression+") AND ("+V+"))":this._layer.definitionExpression),O.where=V,O.spatialRelationship=this._makeRelationshipEnum(i),O.relationParameter=this._makeRelationshipParam(i),O.geometry=null===d?null:d,O.returnDistinctValues=!0,O.returnGeometry=!1,O.outFields=[N],this.executeQuery(O,"execute").then(G=>{if(this._checkCancelled(F),!G.hasOwnProperty("features"))return(0,r.d1)(new Error("Unnexected Result querying statistics from layer"));let X=!1;for(let M=0;M<this._layer.fields.length;M++)if(this._layer.fields[M].name===N){"date"===this._layer.fields[M].type&&(X=!0);break}for(let M=0;M<G.features.length;M++){if(X){const z=G.features[M].attributes[N];f.push(null!==z?new Date(z):z)}else f.push(G.features[M].attributes[N]);if(f.length>=a)break}return 0===G.features.length?f:G.features.length===this._layer.capabilities.query.maxRecordCount&&f.length<a?this._getDistinctPages(e+G.features.length,t,s,i,d,n,a,f,F).then(M=>({calculated:!0,result:M})):f})})}_distinctStat(e,t,s,i,d,n,a){return this._getDistinctPages(0,e,t,s,i,d,n,[],a).then(f=>({calculated:!0,result:f}))}isTable(){return this._layer.isTable||null===this._layer.geometryType||"table"===this._layer.type||""===this._layer.geometryType}_countstat(e,t,s,i){return this.databaseType().then(d=>{const n=new H.Z;if(this._requestStandardised&&(n.sqlFormat="standard"),this.isTable()&&s&&null!==t&&""!==t)return{calculated:!0,result:0};let a=null===i?null===s?"1=1":"":(0,v.zR)(i,d);return this._layer.definitionExpression&&this._useDefinitionExpression&&(a=""!==a?"(("+this._layer.definitionExpression+") AND ("+a+"))":this._layer.definitionExpression),n.where=a,n.where=a,n.spatialRelationship=this._makeRelationshipEnum(t),n.relationParameter=this._makeRelationshipParam(t),n.geometry=null===s?null:s,n.returnGeometry=!1,this.executeQuery(n,"executeForCount").then(f=>({calculated:!0,result:f}))})}_stats(e,t,s,i,d,n,a){return this._ensureLoaded().then(()=>{const f=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsSqlExpression,F=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsStatistics,E=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsDistinct;return"count"===e?E?this._countstat(e,s,i,d):{calculated:!1}:!1===F||!1===(0,v.y5)(t)&&!1===f||!1===t.isStandardized?""!==s||null!==d?{calculated:!1}:this._manualStat(e,t,n,a):"distinct"===e?!1===E?""!==s||null!==d?{calculated:!1}:this._manualStat(e,t,n,a):this._distinctStat(e,t,s,i,d,n,a):this.databaseType().then(N=>{if(this.isTable()&&i&&null!==s&&""!==s)return{calculated:!0,result:null};const O=new H.Z;this._requestStandardised&&(O.sqlFormat="standard");let V=null===d?null===i?"1=1":"":(0,v.zR)(d,N);this._layer.definitionExpression&&this._useDefinitionExpression&&(V=""!==V?"(("+this._layer.definitionExpression+") AND ("+V+"))":this._layer.definitionExpression),O.where=V,O.spatialRelationship=this._makeRelationshipEnum(s),O.relationParameter=this._makeRelationshipParam(s),O.geometry=null===i?null:i;const G=new ue.Z;G.statisticType=(0,p.g3)(e),G.onStatisticField=(0,v.zR)(t,N),G.outStatisticFieldName="ARCADE_STAT_RESULT",O.returnGeometry=!1;let X="ARCADE_STAT_RESULT";return O.outStatistics=[G],this.executeQuery(O,"execute").then(M=>{if(!M.hasOwnProperty("features")||0===M.features.length)return(0,r.d1)(new Error("Unnexected Result querying statistics from layer"));let z=!1;for(let Y=0;Y<M.fields.length;Y++)if("ARCADE_STAT_RESULT"===M.fields[Y].name.toUpperCase()){X=M.fields[Y].name,"date"===M.fields[Y].type&&(z=!0);break}if(z){let Y=M.features[0].attributes[X];return null!==Y&&(Y=new Date(M.features[0].attributes[X])),{calculated:!0,result:Y}}return{calculated:!0,result:M.features[0].attributes[X]}})})})}_stat(e,t,s,i,d,n,a){return this._stats(e,t,s,i,d,n,a)}_canDoAggregates(e,t){return this._ensureLoaded().then(()=>{let s=!1;const i=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsSqlExpression;if(void 0!==this._layer.capabilities&&null!==this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsStatistics&&!0===this._layer.capabilities.query.supportsOrderBy&&(s=!0),s)for(let d=0;d<t.length-1;d++)null!==t[d].workingexpr&&(!1===t[d].workingexpr.isStandardized||!1===(0,v.y5)(t[d].workingexpr)&&!1===i)&&(s=!1);return!1!==s})}_makeRelationshipEnum(e){if(e.indexOf("esriSpatialRelRelation")>=0)return"relation";switch(e){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return e}_makeRelationshipParam(e){return e.indexOf("esriSpatialRelRelation")>=0?e.split(":")[1]:""}_getAggregatePagesDataSourceDefinition(e,t,s,i,d,n,a){return this._ensureLoaded().then(()=>this.databaseType()).then(f=>{let F="",E=!1,N=!1;null!==n&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(F=n.constructClause(),N=!0),this._layer.capabilities&&this._layer.capabilities.query&&!1===this._layer.capabilities.query.supportsPagination&&(N=!1,E=!0,F=this._layer.objectIdField);const O=[];for(let M=0;M<t.length;M++){const z=new ue.Z;z.onStatisticField=null!==t[M].workingexpr?(0,v.zR)(t[M].workingexpr,f):"",z.outStatisticFieldName=t[M].field,z.statisticType=t[M].toStatisticsName(),O.push(z)}""===F&&(F=e.join(","));let V=this._maxQueryRate();const G=this._layer.capabilities.query.maxRecordCount;void 0!==G&&G<V&&(V=G);let X=null===d?null===i?"1=1":"":(0,v.zR)(d,f);return this._layer.definitionExpression&&this._useDefinitionExpression&&(X=""!==X?"(("+this._layer.definitionExpression+") AND ("+X+"))":this._layer.definitionExpression),new _.Z([],["GETPAGES"],N,{groupbypage:!0,spatialRel:this._makeRelationshipEnum(s),relationParam:this._makeRelationshipParam(s),outFields:["*"],useOIDpagination:E,generatedOid:a,resultRecordCount:V,resultOffset:0,groupByFieldsForStatistics:e,outStatistics:O,geometry:null===i?null:i,where:X,orderByFields:F,returnGeometry:!1,returnIdsOnly:!1,internal:{lastMaxId:-1,set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})})}_getAgregagtePhysicalPage(e,t,s){try{let i=e.pagesDefinition.where;!0===e.pagesDefinition.useOIDpagination&&(i=""!==i?"("+i+") AND ("+e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString()+")":e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString());const d=e.pagesDefinition.internal.lastRetrieved,n=d,a=e.pagesDefinition.internal.lastPage,f=new H.Z;return this._requestStandardised&&(f.sqlFormat="standard"),f.where=i,f.spatialRelationship=e.pagesDefinition.spatialRel,f.relationParameter=e.pagesDefinition.relationParam,f.outFields=e.pagesDefinition.outFields,f.outStatistics=e.pagesDefinition.outStatistics,f.geometry=e.pagesDefinition.geometry,f.groupByFieldsForStatistics=e.pagesDefinition.groupByFieldsForStatistics,f.num=e.pagesDefinition.resultRecordCount,f.start=e.pagesDefinition.internal.lastPage,f.returnGeometry=e.pagesDefinition.returnGeometry,f.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,this.isTable()&&f.geometry&&f.spatialRelationship?(0,r.DB)([]):this.executeQuery(f,"execute").then(F=>{if(this._checkCancelled(s),!F.hasOwnProperty("features"))return(0,r.d1)(new Error("Unnexected Result querying aggregates from layer"));const E=[];if(e.pagesDefinition.internal.lastPage!==a)return[];for(let N=0;N<F.features.length;N++)e.pagesDefinition.internal.set[n+N]=F.features[N].attributes[e.pagesDefinition.generatedOid];for(let N=0;N<F.features.length;N++)E.push(new T.Z({attributes:F.features[N].attributes,geometry:null}));return!0===e.pagesDefinition.useOIDpagination?0===F.features.length?e.pagesDefinition.internal.fullyResolved=!0:e.pagesDefinition.internal.lastMaxId=F.features[F.features.length-1].attributes[e.pagesDefinition.generatedOid]:(void 0===F.exceededTransferLimit&&F.features.length!==e.pagesDefinition.resultRecordCount||!1===F.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=d+F.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,E})}catch(i){return(0,r.d1)(i)}}static create(e,t,s,i,d){const n=new Z.default({url:e,outFields:null===t?["*"]:t});return new se({layer:n,spatialReference:s,lrucache:i,interceptor:d})}relationshipMetaData(){return this._layer&&this._layer.source&&this._layer.source.sourceJSON&&this._layer.source.sourceJSON.relationships?this._layer.source.sourceJSON.relationships:[]}serviceUrl(){return(0,y.US)(this._layer.parsedUrl.path)}queryAttachments(e,t,s,i,d){if(this._layer.capabilities.data.supportsAttachment&&this._layer.capabilities.operations.supportsQueryAttachments){const n={objectIds:[e],returnMetadata:d};return(t&&t>0||s&&s>0)&&(n.size=[t&&t>0?t:0,s&&s>0?s:t+1]),i&&i.length>0&&(n.attachmentTypes=i),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:n,method:"attachments"}),this._layer.queryAttachments(n).then(a=>{const f=[];return a&&a[e]&&a[e].forEach(F=>{const E=this._layer.parsedUrl.path+"/"+e.toString()+"/attachments/"+F.id.toString();let N=null;d&&F.exifInfo&&(N=ye.Z.convertJsonToArcade(F.exifInfo,!0)),f.push(new x.Z(F.id,F.name,F.contentType,F.size,E,N))}),f})}return(0,r.DB)([])}queryRelatedFeatures(e){const t={f:"json",relationshipId:e.relationshipId.toString(),definitionExpression:e.where,outFields:e.outFields.join(","),returnGeometry:e.returnGeometry.toString()};return null!=e.resultOffset&&(t.resultOffset=e.resultOffset.toString()),null!=e.resultRecordCount&&(t.resultRecordCount=e.resultRecordCount.toString()),e.orderByFields&&(t.orderByFields=e.orderByFields.join(",")),e.objectIds.length>0&&(t.objectIds=e.objectIds.join(",")),e.outSpatialReference&&(t.outSR=JSON.stringify(e.outSpatialReference.toJSON())),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preRequestCallback({layer:this._layer,queryPayload:t,method:"relatedrecords",url:this._layer.parsedUrl.path+"/queryRelatedRecords"}),(0,U.default)(this._layer.parsedUrl.path+"/queryRelatedRecords",{responseType:"json",query:t}).then(s=>{if(s.data){const i={},d=s.data;if(d&&d.relatedRecordGroups){const n=d.spatialReference;for(const a of d.relatedRecordGroups){const f=a.objectId,F=[];for(const E of a.relatedRecords){E.geometry&&(E.geometry.spatialReference=n);const N=new T.Z({geometry:E.geometry?(0,K.im)(E.geometry):null,attributes:E.attributes});F.push(N)}i[f]={features:F,exceededTransferLimit:!0===d.exceededTransferLimit}}}return i}return(0,r.d1)("Invalid Request")})}getFeatureByObjectId(e,t){const s=new de.Z({url:this._layer.parsedUrl.path}),i=new H.Z;return i.outFields=t,i.returnGeometry=!1,i.outSpatialReference=this.spatialReference,i.where=this.objectIdField+"="+e.toString(),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:i,method:"execute"}),s.execute(i).then(d=>1===d.features.length?d.features[0]:null)}getIdentityUser(){return this.load().then(()=>{var e;const t=null==(e=q.id)?void 0:e.findCredential(this._layer.url);return t?t.userId:null})}getOwningSystemUrl(){return this.load().then(()=>{var e;const t=null==(e=q.id)?void 0:e.findServerInfo(this._layer.url);if(t)return(0,r.DB)(t.owningSystemUrl);let s=this._layer.url;const i=s.toLowerCase().indexOf("/rest/services");return s=i>-1?s.substring(0,i):s,s?(s+="/rest/info",(0,r.Ue)((d,n)=>{(0,U.default)(s,{query:{f:"json"}}).then(a=>{let f="";a.data&&a.data.owningSystemUrl&&(f=a.data.owningSystemUrl),d(f)},a=>{d("")})})):(0,r.DB)("")})}getDataSourceFeatureSet(){const e=new se({layer:this._layer,spatialReference:this.spatialReference,outFields:this._overrideFields,includeGeometry:!this._removeGeometry,lrucache:this.recentlyUsedQueries,interceptor:this.featureSetQueryInterceptor});return e._useDefinitionExpression=!1,e}}var ge=w(16776),he=w(67010);class me extends L.Z{constructor(e){super(e),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerRelated",this._findObjectId=-1,this._requestStandardised=!1,this._removeGeometry=!1,this._overrideFields=null,this.featureObjectId=null,this.relatedLayer=null,this.relationship=null,e.spatialReference&&(this.spatialReference=e.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=e.layer,this._wset=null,this._findObjectId=e.objectId,this.featureObjectId=e.objectId,this.relationship=e.relationship,this.relatedLayer=e.relatedLayer,void 0!==e.outFields&&(this._overrideFields=e.outFields),void 0!==e.includeGeometry&&(this._removeGeometry=!1===e.includeGeometry)}_maxQueryRate(){return y.tI}end(){return this._layer}optimisePagingFeatureQueries(){}load(){return null===this._loadPromise&&(this._loadPromise=(0,r.Ue)((e,t)=>{(0,r.$6)([this._layer.load(),this.relatedLayer.load()]).then(()=>{this._initialiseFeatureSet(),e(this)},t)})),this._loadPromise}nativeCapabilities(){return this.relatedLayer.nativeCapabilities()}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this.relatedLayer.geometryType,this.fields=this.relatedLayer.fields.slice(0),null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const t=[],s=[];for(const i of this.fields)if("oid"===i.type)t.push(i),s.push(i.name);else for(const d of this._overrideFields)if(d.toLowerCase()===i.name.toLowerCase()){t.push(i),s.push(i.name);break}this.fields=t,this._overrideFields=s}const e=this._layer.nativeCapabilities();e&&(this._databaseType=e.databaseType,this._requestStandardised=e.requestStandardised),this.objectIdField=this.relatedLayer.objectIdField,this.globalIdField=this.relatedLayer.globalIdField,this.hasM=this.relatedLayer.supportsM,this.hasZ=this.relatedLayer.supportsZ,this.typeIdField=this.relatedLayer.typeIdField,this.types=this.relatedLayer.types}databaseType(){return this.relatedLayer.databaseType().then(()=>(this._databaseType=this.relatedLayer._databaseType,this._databaseType))}isTable(){return this.relatedLayer.isTable()}_isInFeatureSet(){return y.dj.InFeatureSet}_candidateIdTransform(e){return e}_getSet(e){return null===this._wset?this._ensureLoaded().then(()=>this._getFilteredSet("",null,null,null,e)).then(t=>(this._wset=t,t)):(0,r.DB)(this._wset)}_changeFeature(e){const t={};for(const s of this.fields)t[s.name]=e.attributes[s.name];return new T.Z({geometry:!0===this._removeGeometry?null:e.geometry,attributes:t})}_getFilteredSet(e,t,s,i,d){return this.databaseType().then(()=>{if(this.isTable()&&t&&null!==e&&""!==e)return new _.Z([],[],!0,null);const n=this._layer.nativeCapabilities();if(!1===n.canQueryRelated)return new _.Z([],[],!0,null);if(n.capabilities.queryRelated&&n.capabilities.queryRelated.supportsPagination)return this._getFilteredSetUsingPaging(e,t,s,i,d);let a="",f=!1;null!==i&&n.capabilities&&n.capabilities.queryRelated&&!0===n.capabilities.queryRelated.supportsOrderBy&&(a=i.constructClause(),f=!0);const F=new he.Z;F.objectIds=[this._findObjectId];const E=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this.relatedLayer.fields?this.relatedLayer.fields.map(O=>O.name):["*"]);F.outFields=E,F.relationshipId=this.relationship.id,F.where="1=1";let N=!0;return!0===this._removeGeometry&&(N=!1),F.returnGeometry=N,this._requestStandardised&&(F.sqlFormat="standard"),F.outSpatialReference=this.spatialReference,F.orderByFields=""!==a?a.split(","):null,n.source.queryRelatedFeatures(F).then(O=>{this._checkCancelled(d);const V=O[this._findObjectId]?O[this._findObjectId].features:[],G=[];for(let z=0;z<V.length;z++)this._featureCache[V[z].attributes[this._layer.objectIdField]]=V[z],G.push(V[z].attributes[this._layer.objectIdField]);const X=t&&null!==e&&""!==e,M=null!=s;return new _.Z(X||M?G:[],X||M?[]:G,f,null)})})}_fieldsIncludingObjectId(e){if(null===e)return[this.objectIdField];const t=e.slice(0);if(t.indexOf("*")>-1)return t;let s=!1;for(const i of t)if(i.toUpperCase()===this.objectIdField.toUpperCase()){s=!0;break}return!1===s&&t.push(this.objectIdField),t}_getFilteredSetUsingPaging(e,t,s,i,d){try{let n="",a=!1;const f=this._layer.nativeCapabilities();return null!==i&&f&&f.capabilities.queryRelated&&!0===f.capabilities.queryRelated.supportsOrderBy&&(n=i.constructClause(),a=!0),this.databaseType().then(()=>{let E=this._maxQueryRate();const N=f.capabilities.query.maxRecordCount;void 0!==N&&N<E&&(E=N);const O=t&&null!==e&&""!==e,V=null!=s;let G=null,X=!0;!0===this._removeGeometry&&(X=!1);const M=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this.relatedLayer.fields?this.relatedLayer.fields.map(z=>z.name):["*"]);return G=new _.Z(O||V?["GETPAGES"]:[],O||V?[]:["GETPAGES"],a,{outFields:M.join(","),resultRecordCount:E,resultOffset:0,objectIds:[this._findObjectId],where:"1=1",orderByFields:n,returnGeometry:X,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}}),this._expandPagedSet(G,E,0,0,d).then(()=>G)})}catch(n){return(0,r.d1)(n)}}_expandPagedSet(e,t,s,i,d){return this._expandPagedSetFeatureSet(e,t,s,i,d)}_clonePageDefinition(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}}_getPhysicalPage(e,t,s){try{const i=e.pagesDefinition.internal.lastRetrieved,d=i,n=e.pagesDefinition.internal.lastPage,a=this._layer.nativeCapabilities(),f=new he.Z;return!0===this._requestStandardised&&(f.sqlFormat="standard"),f.relationshipId=this.relationship.id,f.objectIds=e.pagesDefinition.objectIds,f.resultOffset=e.pagesDefinition.internal.lastPage,f.resultRecordCount=e.pagesDefinition.resultRecordCount,f.outFields=e.pagesDefinition.outFields.split(","),f.where=e.pagesDefinition.where,f.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,f.returnGeometry=e.pagesDefinition.returnGeometry,f.outSpatialReference=this.spatialReference,a.source.queryRelatedFeatures(f).then(F=>{if(this._checkCancelled(s),e.pagesDefinition.internal.lastPage!==n)return 0;const E=F[this._findObjectId]?F[this._findObjectId].features:[];for(let O=0;O<E.length;O++)e.pagesDefinition.internal.set[d+O]=E[O].attributes[this._layer.objectIdField];for(let O=0;O<E.length;O++)this._featureCache[E[O].attributes[this._layer.objectIdField]]=E[O];return E.length!==e.pagesDefinition.resultRecordCount&&(!F[this._findObjectId]||!1===F[this._findObjectId].exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=i+E.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,E.length})}catch(i){return(0,r.d1)(i)}}_getFeatures(e,t,s,i){const d=[];-1!==t&&void 0===this._featureCache[t]&&d.push(t);const n=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(e,n))return this._expandPagedSet(e,n,0,0,i).then(()=>this._getFeatures(e,t,s,i));let a=0;for(let f=e._lastFetchedIndex;f<e._known.length&&(a++,a<=s&&(e._lastFetchedIndex+=1),!("GETPAGES"!==e._known[f]&&void 0===this._featureCache[e._known[f]]&&(e._known[f]!==t&&d.push(e._known[f]),d.length>s)))&&!(a>=s&&0===d.length);f++);return 0===d.length?(0,r.DB)("success"):(0,r.d1)(new Error("Unaccounted for Features. Not in Feature Collection"))}_refineSetBlock(e,t,s){return(0,r.DB)(e)}_stat(e,t,s,i,d,n,a){return(0,r.DB)({calculated:!1})}get gdbVersion(){return this.relatedLayer.gdbVersion}_canDoAggregates(e,t,s,i,d){return(0,r.DB)(!1)}relationshipMetaData(){return this.relatedLayer.relationshipMetaData()}serviceUrl(){return this.relatedLayer.serviceUrl()}queryAttachments(e,t,s,i,d){return this.relatedLayer.queryAttachments(e,t,s,i,d)}getFeatureByObjectId(e,t){return this.relatedLayer.getFeatureByObjectId(e,t)}getOwningSystemUrl(){return this.relatedLayer.getOwningSystemUrl()}getIdentityUser(){return this.relatedLayer.getIdentityUser()}getDataSourceFeatureSet(){return this.relatedLayer}}var Q=w(53791),Fe=w(84687),Se=w(55463);function we(){null===Q.Z.applicationCache&&(Q.Z.applicationCache=new Q.Z)}function ne(C,e){if(Q.Z.applicationCache){const t=Q.Z.applicationCache.getLayerInfo(C);if(t)return t.then(d=>(0,r.DB)(new Z.default({url:C,outFields:e,sourceJSON:d})));const s=new Z.default({url:C,outFields:e});let i=(0,r.Ue)((d,n)=>{s.load().then(()=>{d(s.sourceJSON)},a=>{n(a)})});return Q.Z.applicationCache&&(Q.Z.applicationCache.setLayerInfo(C,i),i=i.catch(d=>{throw Q.Z.applicationCache.clearLayerInfo(C),d})),i.then(()=>(0,r.DB)(s))}return(0,r.DB)(new Z.default({url:C,outFields:e}))}function ae(C,e,t,s,i,d=null){return ne(C,["*"]).then(n=>(0,r.DB)(ee(n,e,t,s,i,d)))}function ee(C,e=null,t=null,s=!0,i=null,d=null){return!0===C._hasMemorySource()?new ge.Z({layer:C,spatialReference:e,outFields:t,includeGeometry:s,lrucache:i,interceptor:d}):new se({layer:C,spatialReference:e,outFields:t,includeGeometry:s,lrucache:i,interceptor:d})}function ce(C){if(null!==Q.Z.applicationCache){const t=Q.Z.applicationCache.getLayerInfo(C);if(null!==t)return t}let e=(0,U.default)(C,{responseType:"json",query:{f:"json"}}).then(t=>{if(t.data){const s=t.data;return s.layers||(s.layers=[]),s.tables||(s.tables=[]),(0,r.DB)(s)}return(0,r.DB)({layers:[],tables:[]})});return null!==Q.Z.applicationCache&&(Q.Z.applicationCache.setLayerInfo(C,e),e=e.catch(t=>{throw Q.Z.applicationCache.clearLayerInfo(C),t})),e}function be(C,e){const t={metadata:null,networkId:-1,unVersion:3,terminals:[],queryelem:null,layerNameLkp:{},lkp:null};return ce(C).then(s=>{if(t.metadata=s,s.controllerDatasetLayers&&null!=s.controllerDatasetLayers.utilityNetworkLayerId){if(s.layers)for(const d of s.layers)t.layerNameLkp[d.id]=d.name;if(s.tables)for(const d of s.tables)t.layerNameLkp[d.id]=d.name;const i=s.controllerDatasetLayers.utilityNetworkLayerId;return t.networkId=i,function De(C,e){const t="QUERYDATAELEMTS:"+e.toString()+":"+C;if(null!==Q.Z.applicationCache){const i=Q.Z.applicationCache.getLayerInfo(t);if(null!==i)return i}let s=(0,U.default)(C+"/queryDataElements",{method:"post",responseType:"json",query:{layers:JSON.stringify([e.toString()]),f:"json"}}).then(i=>{if(i.data){const d=i.data;if(d.layerDataElements&&d.layerDataElements[0])return d.layerDataElements[0]}throw new Error("Not Found")});return null!==Q.Z.applicationCache&&(Q.Z.applicationCache.setLayerInfo(t,s),s=s.catch(i=>{throw Q.Z.applicationCache.clearLayerInfo(t),i})),s}(C,i).then(d=>{if(d){t.queryelem=d,t.queryelem&&t.queryelem.dataElement&&void 0!==t.queryelem.dataElement.schemaGeneration&&(t.unVersion=t.queryelem.dataElement.schemaGeneration),t.lkp={},t.queryelem.dataElement.domainNetworks||(t.queryelem.dataElement.domainNetworks=[]);for(const n of t.queryelem.dataElement.domainNetworks){for(const a of n.edgeSources?n.edgeSources:[]){const f={layerId:a.layerId,sourceId:a.sourceId,className:t.layerNameLkp[a.layerId]?t.layerNameLkp[a.layerId]:null};f.className&&(t.lkp[f.className]=f)}for(const a of n.junctionSources?n.junctionSources:[]){const f={layerId:a.layerId,sourceId:a.sourceId,className:t.layerNameLkp[a.layerId]?t.layerNameLkp[a.layerId]:null};f.className&&(t.lkp[f.className]=f)}}if(t.queryelem.dataElement.terminalConfigurations)for(const n of t.queryelem.dataElement.terminalConfigurations)for(const a of n.terminals)t.terminals.push({terminalId:a.terminalId,terminalName:a.terminalName});return function Ie(C){if(null!==Q.Z.applicationCache){const t=Q.Z.applicationCache.getLayerInfo(C);if(null!==t)return t}let e=(0,U.default)(C,{responseType:"json",query:{f:"json"}}).then(t=>(0,r.DB)(t.data?t.data:null));return null!==Q.Z.applicationCache&&(Q.Z.applicationCache.setLayerInfo(C,e),e=e.catch(t=>{throw Q.Z.applicationCache.clearLayerInfo(C),t})),e}(C+"/"+i).then(n=>{if(n.systemLayers&&null!=n.systemLayers.associationsTableId){const a=[];return t.unVersion>=4&&(a.push("STATUS"),a.push("PERCENTALONG")),ae(C+"/"+n.systemLayers.associationsTableId.toString(),e,["OBJECTID","FROMNETWORKSOURCEID","TONETWORKSOURCEID","FROMGLOBALID","TOGLOBALID","TOTERMINALID","FROMTERMINALID","ASSOCIATIONTYPE","ISCONTENTVISIBLE","GLOBALID",...a],!1,null,null).then(f=>f.load()).then(f=>t.unVersion>=4?(f=f.filter(b.WhereClause.create("STATUS NOT IN (1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 23, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 41, 42, 43, 44, 45, 46, 47, 49, 50, 51, 52, 53, 54, 55, 57, 58, 59, 60, 61, 62,63)",f.getFieldsIndex()))).load():f).then(f=>({lkp:t.lkp,associations:f,unVersion:t.unVersion,terminals:t.terminals}))}return{associations:null,unVersion:t.unVersion,lkp:null,terminals:[]}})}return{associations:null,unVersion:t.unVersion,lkp:null,terminals:[]}})}return{associations:null,unVersion:t.unVersion,lkp:null,terminals:[]}})}function Ce(C,e,t,s=null,i=null,d=!0,n=null,a=null){let f=C.serviceUrl();return f?(f="/"===f.charAt(f.length-1)?f+e.relatedTableId.toString():f+"/"+e.relatedTableId.toString(),ae(f,s,i,d,n,a).then(F=>new me({layer:C,relatedLayer:F,relationship:e,objectId:t,spatialReference:s,outFields:i,includeGeometry:d,lrucache:n,interceptor:a}))):null}R.Z.registerAction(),j.registerAction(),D.Z.registerAction(),A.Z.registerAction(),B.Z.registerAction();class ve extends k.Z{constructor(e,t=null,s=null,i=null){super(),this._map=e,this._overridespref=t,this.lrucache=s,this.interceptor=i,this._instantLayers=[]}makeAndAddFeatureSet(e,t=!0,s=null){const i=ee(e,this._overridespref,null===s?["*"]:s,t,this.lrucache,this.interceptor);return this._instantLayers.push({featureset:i,opitem:e,includeGeometry:t,outFields:JSON.stringify(s)}),i}featureSetByName(e,t=!0,s=null){if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then(()=>{try{return this.featureSetByName(e,t,s)}catch(n){return(0,r.d1)(n)}});null===s&&(s=["*"]),s=(s=s.slice(0)).sort();const i=JSON.stringify(s);for(let n=0;n<this._instantLayers.length;n++){const a=this._instantLayers[n];if(a.opitem.title===e&&a.includeGeometry===t&&a.outFields===i)return this.resolvePromise(this._instantLayers[n].featureset)}const d=this._map.layers.find(n=>n instanceof Z.default&&n.title===e);if(d)return this.resolvePromise(this.makeAndAddFeatureSet(d,t,s));if(this._map.tables){const n=this._map.tables.find(a=>!!(a.title&&a.title===e||a.title&&a.title===e));if(n){if(n instanceof Z.default)return this.resolvePromise(this.makeAndAddFeatureSet(n,t,s));if(!n._materializedTable){const a=n.outFields?n:oe(re({},n),{outFields:["*"]});n._materializedTable=new Z.default(a)}return n._materializedTable.load().then(()=>this.resolvePromise(this.makeAndAddFeatureSet(n._materializedTable,t,s)))}}return this.resolvePromise(null)}featureSetById(e,t=!0,s=["*"]){if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then(()=>{try{return this.featureSetById(e,t,s)}catch(n){return(0,r.d1)(n)}});null===s&&(s=["*"]),s=(s=s.slice(0)).sort();const i=JSON.stringify(s);for(let n=0;n<this._instantLayers.length;n++){const a=this._instantLayers[n];if(a.opitem.id===e&&a.includeGeometry===t&&a.outFields===i)return this.resolvePromise(this._instantLayers[n].featureset)}const d=this._map.layers.find(n=>n instanceof Z.default&&n.id===e);if(d)return this.resolvePromise(this.makeAndAddFeatureSet(d,t,s));if(this._map.tables){const n=this._map.tables.find(a=>a.id===e);if(n){if(n instanceof Z.default)return this.resolvePromise(this.makeAndAddFeatureSet(n,t,s));if(!n._materializedTable){const a=oe(re({},n),{outFields:["*"]});n._materializedTable=new Z.default(a)}return n._materializedTable.load().then(()=>this.resolvePromise(this.makeAndAddFeatureSet(n._materializedTable,t,s)))}}return this.resolvePromise(null)}}class le extends k.Z{constructor(e,t=null,s=null,i=null){super(),this._url=e,this._overridespref=t,this.lrucache=s,this.interceptor=i,this.metadata=null,this._instantLayers=[]}get url(){return this._url}makeAndAddFeatureSet(e,t=!0,s=null){const i=ee(e,this._overridespref,null===s?["*"]:s,t,this.lrucache);return this._instantLayers.push({featureset:i,opitem:e,includeGeometry:t,outFields:JSON.stringify(s)}),i}_loadMetaData(){return ce(this._url).then(e=>(this.metadata=e,e))}load(){return this._loadMetaData()}clone(){return new le(this._url,this._overridespref,this.lrucache,this.interceptor)}featureSetByName(e,t=!0,s=null){null===s&&(s=["*"]),s=(s=s.slice(0)).sort();const i=JSON.stringify(s);for(let d=0;d<this._instantLayers.length;d++){const n=this._instantLayers[d];if(n.opitem.title===e&&n.includeGeometry===t&&n.outFields===i)return this.resolvePromise(this._instantLayers[d].featureset)}return this._loadMetaData().then(d=>{let n=null;for(const a of d.layers?d.layers:[])a.name===e&&(n=a);if(!n)for(const a of d.tables?d.tables:[])a.name===e&&(n=a);return n?ne(this._url+"/"+n.id,["*"]).then(a=>this.makeAndAddFeatureSet(a,t,s)):this.resolvePromise(null)})}featureSetById(e,t=!0,s=["*"]){null===s&&(s=["*"]),s=(s=s.slice(0)).sort();const i=JSON.stringify(s);e=null!=e?e.toString():"";for(let d=0;d<this._instantLayers.length;d++){const n=this._instantLayers[d];if(n.opitem.id===e&&n.includeGeometry===t&&n.outFields===i)return this.resolvePromise(this._instantLayers[d].featureset)}return this._loadMetaData().then(d=>{let n=null;for(const a of d.layers?d.layers:[])null!=a.id&&a.id.toString()===e&&(n=a);if(!n)for(const a of d.tables?d.tables:[])null!=a.id&&a.id.toString()===e&&(n=a);return n?ne(this._url+"/"+n.id,["*"]).then(a=>this.makeAndAddFeatureSet(a,t,s)):this.resolvePromise(null)})}}function Ee(C,e,t=null,s=null){return new ve(C,e,t,s)}function Re(C,e,t=null,s=null){return new le(C,e,t,s)}function Te(C,e){return null===C?e:new Fe.Z({url:C.field("url")})}function Pe(C,e,t){return q.id.findCredential(C.restUrl)?"loaded"===C.loadStatus&&""===e&&C.user&&C.user.sourceJSON&&!1===t?(0,r.DB)(C.user.sourceJSON):""===e?(0,U.default)(C.restUrl+"/community/self",{responseType:"json",query:re({f:"json"},!1===t?{}:{returnUserLicenseTypeExtensions:!0})}).then(s=>{if(s.data){const i=s.data;if(i&&i.username)return(0,r.DB)(i)}return(0,r.DB)(null)}):(0,U.default)(C.restUrl+"/community/users/"+e,{responseType:"json",query:{f:"json"}}).then(s=>{if(s.data){const i=s.data;return i.error?null:(0,r.DB)(i)}return(0,r.DB)(null)}):(0,r.DB)(null)}function xe(C,e,t,s,i){if(null===C)return null;if(C instanceof Z.default){switch(e){case"datasource":return ee(C,i,C.outFields,!0,t,s).getDataSourceFeatureSet();case"parent":case"root":return ee(C,i,C.outFields,!0,t,s)}return null}if(C instanceof L.Z)switch(e){case"datasource":return C.getDataSourceFeatureSet();case"parent":return C;case"root":return C.getRootFeatureSet()}return null}function Oe(C,e,t,s,i,d,n,a=null){if(Q.Z.applicationCache){const f=Q.Z.applicationCache.getLayerInfo(C+":"+d.url);if(f)return f.then(F=>{try{const E=new Z.default({url:(0,y.US)(F.url)+"/"+e,outFields:["*"]});return(0,r.DB)(ee(E,t,s,i,n,a))}catch(E){return(0,r.d1)(E)}},F=>(0,r.d1)(F))}return(0,r.Ue)((f,F)=>{const E=new Se.default({id:C,portal:d}).load();Q.Z.applicationCache&&Q.Z.applicationCache.setLayerInfo(C+":"+d.url,E),E.then(N=>{try{const O=new Z.default({url:(0,y.US)(N.url)+"/"+e,outFields:["*"]});f(ee(O,t,s,i,n,a))}catch(O){F(O)}},N=>{Q.Z.applicationCache&&Q.Z.applicationCache.clearLayerInfo(C+":"+d.url),F(N)})})}},52724:(J,W,w)=>{w.d(W,{Xx:()=>b,QP:()=>y,$X:()=>S,yN:()=>p,TO:()=>v});var q=w(88879),U=w(27187),k=w(49086),R=w(91510),T=w(77132),P=w(83947),I=w(10699),D=w(10410),L=w(65234);class _{constructor(l){this.field=l,this.sqlRewritable=!1}postInitialization(l,u){}}class S extends _{constructor(l){super(l),this.sqlRewritable=!0}extractValue(l){return l.attributes[this.field.name]}rewriteSql(l){return{rewritten:this.sqlRewritable,where:l}}}class y extends _{constructor(l,u,r){super((0,T.JW)(l)),this.originalField=l,this.sqlRewritable=!0,this.field.name=u,this.field.alias=r}rewriteSql(l,u){return{rewritten:this.sqlRewritable,where:(0,P.bB)(l,this.field.name,this.originalField.name,u.getFieldsIndex())}}extractValue(l){return l.attributes[this.originalField.name]}}let v=(()=>{class g extends _{constructor(u,r,o){super(u),this.codefield=r,this.lkp=o,this.reverseLkp={};for(const h in o)this.reverseLkp[o[h]]=h;this.sqlRewritable=!0}rewriteSql(u,r){const o=this.evaluateNodeToWhereClause(u.parseTree,T.Bj.Standardised,this.field.name,this.codefield instanceof D.WhereClause?(0,P.zR)(this.codefield,T.Bj.Standardised):this.codefield,u.parameters);return o.indexOf(g.BADNESS)>=0?{rewritten:!1,where:u}:{rewritten:this.sqlRewritable,where:D.WhereClause.create(o,r._parent.getFieldsIndex())}}evaluateNodeToWhereClause(u,r,o=null,h=null,c){let m,j,A,B;switch(u.type){case"interval":return(0,P.TE)(this.evaluateNodeToWhereClause(u.value,r,o,h,c),u.qualifier,u.op);case"case_expression":{let x=" CASE ";"simple"===u.format&&(x+=this.evaluateNodeToWhereClause(u.operand,r,o,g.BADNESS,c));for(let K=0;K<u.clauses.length;K++)x+=" WHEN "+this.evaluateNodeToWhereClause(u.clauses[K].operand,r,o,g.BADNESS,c)+" THEN "+this.evaluateNodeToWhereClause(u.clauses[K].value,r,o,g.BADNESS,c);return null!==u.else&&(x+=" ELSE "+this.evaluateNodeToWhereClause(u.else,r,o,g.BADNESS,c)),x+=" END ",x}case"param":{const x=c[u.value.toLowerCase()];if("string"==typeof x)return"'"+c[u.value.toLowerCase()].toString().replace(/'/g,"''")+"'";if(x instanceof Date)return(0,P.oX)(x,r);if(x instanceof Array){const K=[];for(let Z=0;Z<x.length;Z++)"string"==typeof x[Z]?K.push("'"+x[Z].toString().replace(/'/g,"''")+"'"):x[Z]instanceof Date?K.push((0,P.oX)(x[Z],r)):K.push(x[Z].toString());return K}return x.toString()}case"expr_list":j=[];for(const x of u.value)j.push(this.evaluateNodeToWhereClause(x,r,o,h,c));return j;case"unary_expr":return" ( NOT "+this.evaluateNodeToWhereClause(u.expr,r,o,g.BADNESS,c)+" ) ";case"binary_expr":switch(u.operator){case"AND":return" ("+this.evaluateNodeToWhereClause(u.left,r,o,h,c)+" AND "+this.evaluateNodeToWhereClause(u.right,r,o,h,c)+") ";case"OR":return" ("+this.evaluateNodeToWhereClause(u.left,r,o,h,c)+" OR "+this.evaluateNodeToWhereClause(u.right,r,o,h,c)+") ";case"IS":if("null"!==u.right.type)throw new Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(u.left,r,o,h,c)+" IS NULL )";case"ISNOT":if("null"!==u.right.type)throw new Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(u.left,r,o,h,c)+" IS NOT NULL )";case"IN":if(m=[],"expr_list"===u.right.type){if("column_ref"===u.left.type&&u.left.column.toUpperCase()===this.field.name.toUpperCase()){const x=[];let K=!0;for(const Z of u.right.value){if("string"!==Z.type){K=!1;break}if(void 0===this.lkp[Z.value]){K=!1;break}x.push(this.lkp[Z.value].toString())}if(K)return" ("+this.evaluateNodeToWhereClause(u.left,r,o,h,c)+" IN ("+x.join(",")+")) "}return m=this.evaluateNodeToWhereClause(u.right,r,o,h,c)," ("+this.evaluateNodeToWhereClause(u.left,r,o,h,c)+" IN ("+m.join(",")+")) "}return B=this.evaluateNodeToWhereClause(u.right,r,o,h,c),B instanceof Array?" ("+this.evaluateNodeToWhereClause(u.left,r,o,h,c)+" IN ("+B.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(u.left,r,o,h,c)+" IN ("+B+")) ";case"NOT IN":if(m=[],"expr_list"===u.right.type){if("column_ref"===u.left.type&&u.left.column.toUpperCase()===this.field.name.toUpperCase()){const x=[];let K=!0;for(const Z of u.right.value){if("string"!==Z.type){K=!1;break}if(void 0===this.lkp[Z.value]){K=!1;break}x.push(this.lkp[Z.value].toString())}if(K)return" ("+this.evaluateNodeToWhereClause(u.left,r,o,h,c)+" NOT IN ("+x.join(",")+")) "}return m=this.evaluateNodeToWhereClause(u.right,r,o,h,c)," ("+this.evaluateNodeToWhereClause(u.left,r,o,h,c)+" NOT IN ("+m.join(",")+")) "}return B=this.evaluateNodeToWhereClause(u.right,r,o,h,c),B instanceof Array?" ("+this.evaluateNodeToWhereClause(u.left,r,o,h,c)+" NOT IN ("+B.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(u.left,r,o,h,c)+" NOT IN ("+B+")) ";case"BETWEEN":return A=this.evaluateNodeToWhereClause(u.right,r,o,g.BADNESS,c)," ("+this.evaluateNodeToWhereClause(u.left,r,o,g.BADNESS,c)+" BETWEEN "+A[0]+" AND "+A[1]+" ) ";case"NOTBETWEEN":return A=this.evaluateNodeToWhereClause(u.right,r,o,g.BADNESS,c)," ("+this.evaluateNodeToWhereClause(u.left,r,o,g.BADNESS,c)+" NOT BETWEEN "+A[0]+" AND "+A[1]+" ) ";case"LIKE":return""!==u.escape?" ("+this.evaluateNodeToWhereClause(u.left,r,o,g.BADNESS,c)+" LIKE "+this.evaluateNodeToWhereClause(u.right,r,o,g.BADNESS,c)+" ESCAPE '"+u.escape+"') ":" ("+this.evaluateNodeToWhereClause(u.left,r,o,g.BADNESS,c)+" LIKE "+this.evaluateNodeToWhereClause(u.right,r,o,g.BADNESS,c)+") ";case"NOT LIKE":return""!==u.escape?" ("+this.evaluateNodeToWhereClause(u.left,r,o,g.BADNESS,c)+" NOT LIKE "+this.evaluateNodeToWhereClause(u.right,r,o,g.BADNESS,c)+" ESCAPE '"+u.escape+"') ":" ("+this.evaluateNodeToWhereClause(u.left,r,o,g.BADNESS,c)+" NOT LIKE "+this.evaluateNodeToWhereClause(u.right,r,o,g.BADNESS,c)+") ";case"<>":case"=":if("column_ref"===u.left.type&&"string"===u.right.type){if(u.left.column.toUpperCase()===this.field.name.toUpperCase()&&void 0!==this.lkp[u.right.value.toString()])return" ("+h+" "+u.operator+" "+this.lkp[u.right.value.toString()].toString()+") "}else if("column_ref"===u.right.type&&"string"===u.left.type&&u.right.column.toUpperCase()===this.field.name.toUpperCase())return" ("+this.lkp[u.right.value.toString()].toString()+" "+u.operator+" "+h+") ";return" ("+this.evaluateNodeToWhereClause(u.left,r,o,g.BADNESS,c)+" "+u.operator+" "+this.evaluateNodeToWhereClause(u.right,r,o,g.BADNESS,c)+") ";case"<":case">":case">=":case"<=":case"*":case"-":case"+":case"/":return" ("+this.evaluateNodeToWhereClause(u.left,r,o,g.BADNESS,c)+" "+u.operator+" "+this.evaluateNodeToWhereClause(u.right,r,o,g.BADNESS,c)+") "}throw new Error("Not Supported Operator "+u.operator);case"null":return"null";case"bool":return!0===u.value?"1":"0";case"string":return"'"+u.value.toString().replace(/'/g,"''")+"'";case"timestamp":case"date":return(0,P.oX)(u.value,r);case"number":return u.value.toString();case"current_time":return(0,P.vR)("date"===u.mode,r);case"column_ref":return o&&o.toLowerCase()===u.column.toLowerCase()?"("+h+")":u.column;case"function":{const x=this.evaluateNodeToWhereClause(u.args,r,o,g.BADNESS,c);return(0,P.fz)(u.name,x,r)}}throw new Error("Unsupported sql syntax "+u.type)}extractValue(u){return this.codefield instanceof D.WhereClause?this.reverseLkp[this.codefield.calculateValueCompiled(u)]:this.reverseLkp[u.attributes[this.codefield]]}}return g.BADNESS="_!!!_BAD_LKP_!!!!",g})();class p extends _{constructor(l,u){super(l),this.sql=u}rewriteSql(l,u){return{rewritten:!0,where:(0,P.bB)(l,this.field.name,(0,P.zR)(this.sql,T.Bj.Standardised),u.getFieldsIndex())}}extractValue(l){return this.sql.calculateValueCompiled(l)}}class b extends k.Z{constructor(l){super(l),this._calcFunc=null,this.declaredClass="esri.arcade.featureset.actions.Adapted",this.adaptedFields=null,this._extraFilter=null,this._extraFilter=l.extraFilter,this._parent=l.parentfeatureset,this._maxProcessing=30,this.adaptedFields=l.adaptedFields}static findField(l,u){for(const r of l)if(r.name.toLowerCase()===u.toString().toLowerCase())return r;return null}_initialiseFeatureSet(){null!==this._parent?(this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.spatialReference=new L.Z({wkid:4326}),this.objectIdField="",this.globalIdField="",this.geometryType=T.Qk.point,this.typeIdField="",this.types=null),this.fields=[];for(const l of this.adaptedFields)l.postInitialization(this,this._parent),this.fields.push(l.field)}_getSet(l){return null===this._wset?this._ensureLoaded().then(()=>this._extraFilter?this._getFilteredSet("",null,null,null,l):this._parent._getSet(l)).then(u=>(this._checkCancelled(l),this._wset=new R.Z(u._candidates.slice(0),u._known.slice(0),u._ordered,this._clonePageDefinition(u.pagesDefinition)),this._wset)):(0,I.DB)(this._wset)}_isInFeatureSet(l){return this._parent._isInFeatureSet(l)}_getFeatures(l,u,r,o){const h=[];-1!==u&&void 0===this._featureCache[u]&&h.push(u);const c=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(l,c))return this._expandPagedSet(l,c,0,0,o).then(()=>this._getFeatures(l,u,r,o));let m=0;for(let A=l._lastFetchedIndex;A<l._known.length&&(m++,m<=r&&(l._lastFetchedIndex+=1),!(void 0===this._featureCache[l._known[A]]&&(l._known[A]!==u&&h.push(l._known[A]),h.length>=c)));A++);if(0===h.length)return(0,I.DB)("success");l=new R.Z([],h,l._ordered,null);const j=Math.min(h.length,r);return this._parent._getFeatures(l,-1,j,o).then(()=>{this._checkCancelled(o);const A=[];for(let B=0;B<j;B++){const x=this._parent._featureFromCache(h[B]);void 0!==x&&A.push({geometry:x.geometry,attributes:x.attributes,id:h[B]})}for(const B of A){const x=[];for(const K of this.adaptedFields)x[K.field.name]=K.extractValue(B);this._featureCache[B.id]=new q.Z({attributes:x,geometry:(0,U.r1)(B.geometry)})}return"success"})}_fetchAndRefineFeatures(){return(0,I.d1)(new Error("Fetch and Refine should not be called in this featureset"))}_getFilteredSet(l,u,r,o,h){let c=!1;const m=this.reformulateWithoutAdaptions(r);c=m.cannot,r=m.where;let j=!1;if(null!==o){j=!0;const A=[];for(const B of this.adaptedFields)if(!(B instanceof S)&&!0===o.scanForField(B.field.name)){if(!(B instanceof y)){o=null,j=!1;break}A.push({field:B.field.name,newfield:B.originalField.name})}o&&A.length>0&&(o=o.replaceFields(A))}return null!==r?null!==this._extraFilter&&(r=(0,P.$e)(this._extraFilter,r)):r=this._extraFilter,this._ensureLoaded().then(()=>this._parent._getFilteredSet(l,u,r,o,h)).then(A=>{let B;return this._checkCancelled(h),B=!0===c?new R.Z(A._candidates.slice(0).concat(A._known.slice(0)),[],!0===j&&A._ordered,this._clonePageDefinition(A.pagesDefinition)):new R.Z(A._candidates.slice(0),A._known.slice(0),!0===j&&A._ordered,this._clonePageDefinition(A.pagesDefinition)),B})}reformulateWithoutAdaptions(l){const u={cannot:!1,where:l};if(null!==l)for(const r of this.adaptedFields)if(!0===(0,P.hq)(l,r.field.name)){const o=r.rewriteSql(l,this);if(!0!==o.rewritten){u.cannot=!0,u.where=null;break}u.where=o.where}return u}_stat(l,u,r,o,h,c,m){let j=!1,A=this.reformulateWithoutAdaptions(u);return j=A.cannot,u=A.where,A=this.reformulateWithoutAdaptions(h),j=j||A.cannot,null!==(h=A.where)?null!==this._extraFilter&&(h=(0,P.$e)(this._extraFilter,h)):h=this._extraFilter,!0===j?null===h&&""===r&&null===o?this._manualStat(l,u,c,m):(0,I.DB)({calculated:!1}):this._parent._stat(l,u,r,o,h,c,m).then(B=>!1===B.calculated?null===h&&""===r&&null===o?this._manualStat(l,u,c,m):{calculated:!1}:B)}_canDoAggregates(l,u,r,o,h){if(null===this._parent)return(0,I.DB)(!1);for(let j=0;j<l.length;j++)for(const A of this.adaptedFields)if(l[j].toLowerCase()===A.field.name.toLowerCase()&&!(A instanceof S))return(0,I.DB)(!1);const c=[];for(let j=0;j<u.length;j++){const A=u[j];if(null!==A.workingexpr){const B=this.reformulateWithoutAdaptions(A.workingexpr);if(B.cannot)return(0,I.DB)(!1);const x=A.clone();x.workingexpr=B.where,c.push(x)}else c.push(A)}const m=this.reformulateWithoutAdaptions(h);return m.cannot?(0,I.DB)(!1):(null!==(h=m.where)?null!==this._extraFilter&&(h=(0,P.$e)(this._extraFilter,h)):h=this._extraFilter,this._parent._canDoAggregates(l,c,r,o,h))}_getAggregatePagesDataSourceDefinition(l,u,r,o,h,c,m){if(null===this._parent)return(0,I.d1)(new Error("Should never be called"));const j=[];for(let B=0;B<u.length;B++){const x=u[B];if(null!==x.workingexpr){const K=this.reformulateWithoutAdaptions(x.workingexpr);if(K.cannot)return(0,I.d1)(new Error("Should never be called"));const Z=x.clone();Z.workingexpr=K.where,j.push(Z)}else j.push(x)}const A=this.reformulateWithoutAdaptions(h);return A.cannot?(0,I.d1)(new Error("Should never be called")):(null!==(h=A.where)?null!==this._extraFilter&&(h=(0,P.$e)(this._extraFilter,h)):h=this._extraFilter,this._parent._getAggregatePagesDataSourceDefinition(l,j,r,o,h,c,m))}}},53997:(J,W,w)=>{w.d(W,{Z:()=>D});var q=w(49086),U=w(91510),k=w(77132),R=w(83947),T=w(10699),P=w(10410),I=w(65234);class D extends q.Z{constructor(_){super(_),this.declaredClass="esri.arcade.featureset.actions.AttributeFilter",this._maxProcessing=1e3,this._parent=_.parentfeatureset,_.whereclause instanceof P.WhereClause?(this._whereclause=_.whereclause,this._whereClauseFunction=null):(this._whereClauseFunction=_.whereclause,this._whereclause=null)}_initialiseFeatureSet(){null!==this._parent?(this.fields=this._parent.fields.slice(0),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.fields=[],this.typeIdField="",this.objectIdField="",this.globalIdField="",this.spatialReference=new I.Z({wkid:4326}),this.geometryType=k.Qk.point)}_getSet(_){return null===this._wset?this._ensureLoaded().then(()=>this._parent._getFilteredSet("",null,this._whereclause,null,_)).then(S=>(this._checkCancelled(_),this._wset=null!==this._whereClauseFunction?new U.Z(S._candidates.slice(0).concat(S._known.slice(0)),[],S._ordered,this._clonePageDefinition(S.pagesDefinition)):new U.Z(S._candidates.slice(0),S._known.slice(0),S._ordered,this._clonePageDefinition(S.pagesDefinition)),this._wset)):(0,T.DB)(this._wset)}_isInFeatureSet(_){let S=this._parent._isInFeatureSet(_);return S===k.dj.NotInFeatureSet?S:(S=this._idstates[_],void 0===S?k.dj.Unknown:S)}_getFeature(_,S,y){return this._parent._getFeature(_,S,y)}_getFeatures(_,S,y,v){return this._parent._getFeatures(_,S,y,v)}_featureFromCache(_){return this._parent._featureFromCache(_)}executeWhereClause(_){return this._whereclause.testFeature(_)}executeWhereClauseDeferred(_){if(null!==this._whereClauseFunction)try{const S=this._whereClauseFunction(_);return(0,T.y8)(S)?S:(0,T.DB)(S)}catch(S){return(0,T.d1)(S)}return(0,T.DB)(this.executeWhereClause(_))}_fetchAndRefineFeatures(_,S,y){const v=new U.Z([],_,!1,null),p=Math.min(S,_.length);return this._parent._getFeatures(v,-1,p,y).then(()=>{if(this._checkCancelled(y),null==this._whereClauseFunction){for(let g=0;g<p;g++){const l=this._parent._featureFromCache(_[g]);this._idstates[_[g]]=!0===this.executeWhereClause(l)?k.dj.InFeatureSet:k.dj.NotInFeatureSet}return"success"}const b=[];for(let g=0;g<p;g++){const l=this._parent._featureFromCache(_[g]);b.push(this.executeWhereClauseDeferred(l))}return(0,T.$6)(b).then(g=>{for(let l=0;l<S;l++)this._idstates[_[l]]=!0===g[l]?k.dj.InFeatureSet:k.dj.NotInFeatureSet;return"success"})})}_getFilteredSet(_,S,y,v,p){return null!==this._whereClauseFunction||(null!==y?null!==this._whereclause&&(y=(0,R.$e)(this._whereclause,y)):y=this._whereclause),this._ensureLoaded().then(()=>this._parent._getFilteredSet(_,S,y,v,p)).then(b=>{let g;return this._checkCancelled(p),g=null!==this._whereClauseFunction?new U.Z(b._candidates.slice(0).concat(b._known.slice(0)),[],b._ordered,this._clonePageDefinition(b.pagesDefinition)):new U.Z(b._candidates.slice(0),b._known.slice(0),b._ordered,this._clonePageDefinition(b.pagesDefinition)),g})}_stat(_,S,y,v,p,b,g){if(null!==this._whereClauseFunction)return null===p&&""===y&&null===v?this._manualStat(_,S,b,g):(0,T.DB)({calculated:!1});let l=this._whereclause;return null!==p&&null!==this._whereclause&&(l=(0,R.$e)(this._whereclause,p)),this._parent._stat(_,S,y,v,l,b,g).then(u=>!1===u.calculated?null===p&&""===y&&null===v?this._manualStat(_,S,b,g):{calculated:!1}:u)}_canDoAggregates(_,S,y,v,p){return null!==this._whereClauseFunction?(0,T.DB)(!1):(null!==p?null!==this._whereclause&&(p=(0,R.$e)(this._whereclause,p)):p=this._whereclause,null===this._parent?(0,T.DB)(!1):this._parent._canDoAggregates(_,S,y,v,p))}_getAggregatePagesDataSourceDefinition(_,S,y,v,p,b,g){return null===this._parent?(0,T.d1)(new Error("Should never be called")):(null!==p?null!==this._whereclause&&(p=(0,R.$e)(this._whereclause,p)):p=this._whereclause,this._parent._getAggregatePagesDataSourceDefinition(_,S,y,v,p,b,g))}static registerAction(){q.Z._featuresetFunctions.filter=function(_){if("function"==typeof _)return new D({parentfeatureset:this,whereclause:_});let S=null;return _ instanceof P.WhereClause&&(S=_),new D({parentfeatureset:this,whereclause:S})}}}},95896:(J,W,w)=>{w.d(W,{Z:()=>P});var q=w(47562),U=w(49086),k=w(91510),R=w(57366),T=w(10699);class P extends U.Z{constructor(D){super(D),this._orderbyclause=null,this.declaredClass="esri.arcade.featureset.actions.OrderBy",this._maxProcessing=100,this._orderbyclause=D.orderbyclause,this._parent=D.parentfeatureset}_getSet(D){return null===this._wset?this._ensureLoaded().then(()=>this._getFilteredSet("",null,null,this._orderbyclause,D)).then(L=>(this._checkCancelled(D),this._wset=L,this._wset)):(0,T.DB)(this._wset)}manualOrderSet(D,L){return this.getIdColumnDictionary(D,[],-1,L).then(_=>{this._orderbyclause.order(_);const S=new k.Z([],[],!0,null);for(let y=0;y<_.length;y++)S._known.push(_[y].id);return S})}getIdColumnDictionary(D,L,_,S){if(_<D._known.length-1){const y=this._maxQueryRate();if("GETPAGES"===D._known[_+1])return(0,q.U)(this._parent._expandPagedSet(D,y,0,0,S)).then(()=>this.getIdColumnDictionary(D,L,_,S));let v=_+1;const p=[];for(;v<D._known.length&&"GETPAGES"!==D._known[v];)p.push(D._known[v]),v++;return _+=p.length,(0,q.U)(this._parent._getFeatureBatch(p,S)).then(b=>{this._checkCancelled(S);for(const g of b)L.push({id:g.attributes[this.objectIdField],feature:g});return this.getIdColumnDictionary(D,L,_,S)})}return D._candidates.length>0?(0,q.U)(this._refineSetBlock(D,this._maxProcessingRate(),S)).then(()=>(this._checkCancelled(S),this.getIdColumnDictionary(D,L,_,S))):(0,T.DB)(L)}_isInFeatureSet(D){return this._parent._isInFeatureSet(D)}_getFeatures(D,L,_,S){return this._parent._getFeatures(D,L,_,S)}_featureFromCache(D){if(void 0===this._featureCache[D]){const L=this._parent._featureFromCache(D);return void 0===L?void 0:null===L?null:(this._featureCache[D]=L,L)}return this._featureCache[D]}_fetchAndRefineFeatures(){return(0,T.d1)(new Error("Fetch and Refine should not be called in this featureset"))}_getFilteredSet(D,L,_,S,y){return this._ensureLoaded().then(()=>this._parent._getFilteredSet(D,L,_,null===S?this._orderbyclause:S,y)).then(v=>{this._checkCancelled(y);const p=new k.Z(v._candidates.slice(0),v._known.slice(0),v._ordered,this._clonePageDefinition(v.pagesDefinition));let b=!0;return v._candidates.length>0&&(b=!1),!1===p._ordered?this.manualOrderSet(p,y).then(g=>(!1===b&&(null===L&&null===_||(g=new k.Z(g._candidates.slice(0).concat(g._known.slice(0)),[],g._ordered,this._clonePageDefinition(g.pagesDefinition)))),g)):p})}static registerAction(){U.Z._featuresetFunctions.orderBy=function(D){return""===D?this:new P({parentfeatureset:this,orderbyclause:new R.Z(D)})}}}},79429:(J,W,w)=>{w.d(W,{Z:()=>T});var q=w(49086),U=w(91510),k=w(77132),R=w(10699);class T extends q.Z{constructor(I){super(I),this._topnum=0,this.declaredClass="esri.arcade.featureset.actions.Top",this._countedin=0,this._maxProcessing=100,this._topnum=I.topnum,this._parent=I.parentfeatureset}_getSet(I){return null===this._wset?this._ensureLoaded().then(()=>this._parent._getSet(I)).then(D=>(this._wset=new U.Z(D._candidates.slice(0),D._known.slice(0),!1,this._clonePageDefinition(D.pagesDefinition)),this._setKnownLength(this._wset)>this._topnum&&(this._wset._known=this._wset._known.slice(0,this._topnum)),this._setKnownLength(this._wset)>=this._topnum&&(this._wset._candidates=[]),this._wset)):(0,R.DB)(this._wset)}_setKnownLength(I){return I._known.length>0&&"GETPAGES"===I._known[I._known.length-1]?I._known.length-1:I._known.length}_isInFeatureSet(I){const D=this._parent._isInFeatureSet(I);if(D===k.dj.NotInFeatureSet)return D;const L=this._idstates[I];return L===k.dj.InFeatureSet||L===k.dj.NotInFeatureSet?L:D===k.dj.InFeatureSet&&void 0===L?this._countedin<this._topnum?(this._idstates[I]=k.dj.InFeatureSet,this._countedin++,k.dj.InFeatureSet):(this._idstates[I]=k.dj.NotInFeatureSet,k.dj.NotInFeatureSet):k.dj.Unknown}_expandPagedSet(I,D,L,_,S){if(null===this._parent)return(0,R.d1)(new Error("Parent Paging not implemented"));if(D>this._topnum&&(D=this._topnum),this._countedin>=this._topnum&&I.pagesDefinition.internal.set.length<=I.pagesDefinition.resultOffset){let y=I._known.length;return y>0&&"GETPAGES"===I._known[y-1]&&(I._known.length=y-1),y=I._candidates.length,y>0&&"GETPAGES"===I._candidates[y-1]&&(I._candidates.length=y-1),(0,R.DB)("success")}return this._parent._expandPagedSet(I,D,L,_,S).then(y=>(this._setKnownLength(I)>this._topnum&&(I._known.length=this._topnum),this._setKnownLength(I)>=this._topnum&&(I._candidates.length=0),y))}_getFeatures(I,D,L,_){const S=[],y=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(I,y))return this._expandPagedSet(I,y,0,0,_).then(()=>this._getFeatures(I,D,L,_));-1!==D&&void 0===this._featureCache[D]&&S.push(D);let v=0;for(let g=I._lastFetchedIndex;g<I._known.length&&(v++,v<=L&&(I._lastFetchedIndex+=1),!(void 0===this._featureCache[I._known[g]]&&(I._known[g]!==D&&S.push(I._known[g]),S.length>y)));g++);if(0===S.length)return(0,R.DB)("success");const p=new U.Z([],S,!1,null),b=Math.min(S.length,L);return this._parent._getFeatures(p,-1,b,_).then(()=>{for(let g=0;g<b;g++){const l=this._parent._featureFromCache(S[g]);void 0!==l&&(this._featureCache[S[g]]=l)}return"success"})}_getFilteredSet(I,D,L,_,S){return this._ensureLoaded().then(()=>this._getSet(S)).then(y=>new U.Z(y._candidates.slice(0).concat(y._known.slice(0)),[],!1,this._clonePageDefinition(y.pagesDefinition)))}_refineKnowns(I,D){let L=0,_=null;const S=[];for(let y=0;y<I._candidates.length;y++){const v=this._isInFeatureSet(I._candidates[y]);if(v===k.dj.InFeatureSet){if(I._known.push(I._candidates[y]),L+=1,null===_?_={start:y,end:y}:_.end===y-1?_.end=y:(S.push(_),_={start:y,end:y}),I._known.length>=this._topnum)break}else if(v===k.dj.NotInFeatureSet)null===_?_={start:y,end:y}:_.end===y-1?_.end=y:(S.push(_),_={start:y,end:y}),L+=1;else if(v===k.dj.Unknown)break;if(L>=D)break}null!==_&&S.push(_);for(let y=S.length-1;y>=0;y--)I._candidates.splice(S[y].start,S[y].end-S[y].start+1);this._setKnownLength(I)>this._topnum&&(I._known=I._known.slice(0,this._topnum)),this._setKnownLength(I)>=this._topnum&&(I._candidates=[])}_stat(){return(0,R.DB)({calculated:!1})}_canDoAggregates(){return(0,R.DB)(!1)}static registerAction(){q.Z._featuresetFunctions.top=function(I){return new T({parentfeatureset:this,topnum:I})}}}},16776:(J,W,w)=>{w.d(W,{Z:()=>y});var q=w(88879),U=w(49086),k=w(91510),R=w(77132),T=w(83947),P=w(10699),I=w(21674),D=w(15382),L=w(41638),_=w(36255),S=w(84952);class y extends U.Z{constructor(p){super(p),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerMemory",this._removeGeometry=!1,this._overrideFields=null,this._forceIsTable=!1,p.spatialReference&&(this.spatialReference=p.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=p.layer,this._wset=null,!0===p.isTable&&(this._forceIsTable=!0),void 0!==p.outFields&&(this._overrideFields=p.outFields),void 0!==p.includeGeometry&&(this._removeGeometry=!1===p.includeGeometry)}_maxQueryRate(){return R.tI}end(){return this._layer}optimisePagingFeatureQueries(){}load(){return null===this._loadPromise&&(this._loadPromise=(0,P.Ue)((p,b)=>{if(!0===this._layer.loaded)return this._initialiseFeatureSet(),void p(this);this._layer.when().then(()=>{try{this._initialiseFeatureSet(),p(this)}catch(g){b(g)}},b),this._layer.load()})),this._loadPromise}get gdbVersion(){return""}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this._layer.outFields&&(1!==this._layer.outFields.length||"*"!==this._layer.outFields[0])){const p=[];for(const b of this.fields)if("oid"===b.type)p.push(b);else for(const g of this._layer.outFields)if(g.toLowerCase()===b.name.toLowerCase()){p.push(b);break}this.fields=p}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const p=[],b=[];for(const g of this.fields)if("oid"===g.type)p.push(g),b.push(g.name);else for(const l of this._overrideFields)if(l.toLowerCase()===g.name.toLowerCase()){p.push(g),b.push(g.name);break}this.fields=p,this._overrideFields=b}this.objectIdField=this._layer.objectIdField;for(const p of this.fields)"global-id"===p.type&&(this.globalIdField=p.name);this.hasM=this._layer.supportsM,this.hasZ=this._layer.supportsZ,this._databaseType=R.Bj.Standardised,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types}isTable(){return this._forceIsTable||this._layer.isTable||"table"===this._layer.type||!this._layer.geometryType}_isInFeatureSet(){return R.dj.InFeatureSet}_candidateIdTransform(p){return p}_getSet(p){return null===this._wset?this._ensureLoaded().then(()=>this._getFilteredSet("",null,null,null,p)).then(b=>(this._wset=b,b)):(0,P.DB)(this._wset)}_changeFeature(p){const b={};for(const g of this.fields)b[g.name]=p.attributes[g.name];return new q.Z({geometry:!0===this._removeGeometry?null:p.geometry,attributes:b})}_getFilteredSet(p,b,g,l,u){let r="",o=!1;if(null!==l&&(r=l.constructClause(),o=!0),this.isTable()&&b&&null!==p&&""!==p){const c=new k.Z([],[],!0,null);return(0,P.DB)(c)}const h=new S.Z;return h.where=null===g?null===b?"1=1":"":(0,T.zR)(g,R.Bj.Standardised),h.spatialRelationship=this._makeRelationshipEnum(p),h.outSpatialReference=this.spatialReference,h.orderByFields=""!==r?r.split(","):null,h.geometry=null===b?null:b,h.returnGeometry=!0,h.relationParameter=this._makeRelationshipParam(p),this._layer.queryFeatures(h).then(c=>{if(null===c)return new k.Z([],[],o,null);this._checkCancelled(u);const m=[];return c.features.forEach(j=>{const A=j.attributes[this._layer.objectIdField];m.push(A),this._featureCache[A]=this._changeFeature(j)}),new k.Z([],m,o,null)})}_makeRelationshipEnum(p){if(p.indexOf("esriSpatialRelRelation")>=0)return"relation";switch(p){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return p}_makeRelationshipParam(p){return p.indexOf("esriSpatialRelRelation")>=0?p.split(":")[1]:""}_queryAllFeatures(){if(this._wset)return(0,P.DB)(this._wset);const p=new S.Z;return p.where="1=1",this._ensureLoaded().then(()=>{if(this._layer.source&&this._layer.source.items){const b=[];return this._layer.source.items.forEach(g=>{const l=g.attributes[this._layer.objectIdField];b.push(l),this._featureCache[l]=this._changeFeature(g)}),this._wset=new k.Z([],b,!1,null),this._wset}return this._layer.queryFeatures(p).then(b=>{const g=[];return b.features.forEach(l=>{const u=l.attributes[this._layer.objectIdField];g.push(u),this._featureCache[u]=this._changeFeature(l)}),this._wset=new k.Z([],g,!1,null),this._wset})})}_getFeatures(p,b,g){const l=[];-1!==b&&void 0===this._featureCache[b]&&l.push(b);for(let u=p._lastFetchedIndex;u<p._known.length&&(p._lastFetchedIndex+=1,!(void 0===this._featureCache[p._known[u]]&&(p._known[u]!==b&&l.push(p._known[u]),l.length>g)));u++);return 0===l.length?(0,P.DB)("success"):(0,P.d1)(new Error("Unaccounted for Features. Not in Feature Collection"))}_refineSetBlock(p){return(0,P.DB)(p)}_stat(){return(0,P.DB)({calculated:!1})}_canDoAggregates(){return(0,P.DB)(!1)}relationshipMetaData(){return[]}static _cloneAttr(p){const b={};for(const g in p)b[g]=p[g];return b}nativeCapabilities(){return{title:this._layer.title,canQueryRelated:!1,source:this,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:!0}}static create(p,b){let g=p.layerDefinition.objectIdField;const l=p.layerDefinition.typeIdField?p.layerDefinition.typeIdField:"",u=[];if(p.layerDefinition.types)for(const B of p.layerDefinition.types)u.push(L.Z.fromJSON(B));let r=p.layerDefinition.geometryType;void 0===r&&(r=p.featureSet.geometryType||"");let o=p.featureSet.features;const h=b.toJSON();if(""===g||void 0===g){let B=!1;for(const x of p.layerDefinition.fields)if("oid"===x.type||"esriFieldTypeOID"===x.type){g=x.name,B=!0;break}if(!1===B){let x="FID",K=!0,Z=0;for(;K;){let $=!0;for(const ie of p.layerDefinition.fields)if(ie.name===x){$=!1;break}!0===$?K=!1:(Z++,x="FID"+Z.toString())}p.layerDefinition.fields.push({type:"esriFieldTypeOID",name:x,alias:x});const te=[];for(let $=0;$<o.length;$++)te.push({geometry:p.featureSet.features[$].geometry,attributes:p.featureSet.features[$].attributes?this._cloneAttr(p.featureSet.features[$].attributes):{}}),te[$].attributes[x]=$;o=te,g=x}}const c=[];for(const B of p.layerDefinition.fields)c.push(B instanceof _.Z?B:_.Z.fromJSON(B));let m=r;switch(m){case"esriGeometryPoint":m="point";break;case"esriGeometryPolyline":m="polyline";break;case"esriGeometryPolygon":m="polygon";break;case"esriGeometryExtent":m="extent";break;case"esriGeometryMultipoint":m="multipoint"}for(const B of o)B.geometry&&!(B.geometry instanceof I.Z)&&(B.geometry.type=m,void 0===B.geometry.spatialReference&&(B.geometry.spatialReference=h));const j={outFields:["*"],source:o,fields:c,types:u,typeIdField:l,objectIdField:g,spatialReference:b};j.geometryType=m||"point";const A=new D.default(j);return new y({layer:A,spatialReference:b,isTable:null===m||""===m})}queryAttachments(){return(0,P.DB)([])}getFeatureByObjectId(p){const b=new S.Z;return b.where=this.objectIdField+"="+p.toString(),this._layer.queryFeatures(b).then(g=>1===g.features.length?g.features[0]:null)}getOwningSystemUrl(){return(0,P.DB)("")}getIdentityUser(){return(0,P.DB)("")}}},57366:(J,W,w)=>{function q(k,R){return k===R?0:null===k?-1:null===R?1:k<R?-1:1}w.d(W,{Z:()=>U});class U{constructor(R){const T=R.split(",");this._fields=[],this._directions=[];for(let P=0;P<T.length;P++){const I=T[P].match(/\S+/g);this._fields.push(I[0]),2===I.length?"asc"===I[1].toLowerCase()?this._directions.push(1):this._directions.push(0):this._directions.push(1)}}constructClause(){let R="";for(let T=0;T<this._fields.length;T++)0!==T&&(R+=","),R+=this._fields[T],R+=1===this._directions[T]?" ASC":" DESC";return R}order(R){R.sort((T,P)=>{for(let I=0;I<this._fields.length;I++){const D=this.featureValue(T.feature,this._fields[I],I),L=this.featureValue(P.feature,this._fields[I],I);let _=0;if(_=1===this._directions[I]?q(D,L):-1*q(D,L),0!==_)return _}return 0})}scanForField(R){for(let T=0;T<this._fields.length;T++)if(this._fields[T].toLowerCase().trim()===R.toLowerCase().trim())return!0;return!1}replaceFields(R){let T="";for(let P=0;P<this._fields.length;P++){0!==P&&(T+=",");let I=this._fields[P];for(const D of R)if(I.toLowerCase()===D.field.toLowerCase()){I=D.newfield;break}T+=I,T+=1===this._directions[P]?" ASC":" DESC"}return new U(T)}featureValue(R,T,P){const I=R.attributes[T];if(void 0!==I)return I;for(const D in R.attributes)if(T.toLowerCase()===D.toLowerCase())return this._fields[P]=D,R.attributes[D];return null}}},50011:(J,W,w)=>{w.d(W,{F:()=>g,M:()=>q});const q={Base64:0,Hex:1,String:2,Raw:3};function R(l,u){const r=(65535&l)+(65535&u);return(l>>16)+(u>>16)+(r>>16)<<16|65535&r}function _(l,u,r,o,h,c){return R(function L(l,u){return l<<u|l>>>32-u}(R(R(u,l),R(o,c)),h),r)}function S(l,u,r,o,h,c,m){return _(u&r|~u&o,l,u,h,c,m)}function y(l,u,r,o,h,c,m){return _(u&o|r&~o,l,u,h,c,m)}function v(l,u,r,o,h,c,m){return _(u^r^o,l,u,h,c,m)}function p(l,u,r,o,h,c,m){return _(r^(u|~o),l,u,h,c,m)}function g(l,u=q.Hex){const r=u||q.Base64,o=function b(l,u){l[u>>5]|=128<<u%32,l[14+(u+64>>>9<<4)]=u;let r=1732584193,o=-271733879,h=-1732584194,c=271733878;for(let m=0;m<l.length;m+=16){const j=r,A=o,B=h,x=c;r=S(r,o,h,c,l[m+0],7,-680876936),c=S(c,r,o,h,l[m+1],12,-389564586),h=S(h,c,r,o,l[m+2],17,606105819),o=S(o,h,c,r,l[m+3],22,-1044525330),r=S(r,o,h,c,l[m+4],7,-176418897),c=S(c,r,o,h,l[m+5],12,1200080426),h=S(h,c,r,o,l[m+6],17,-1473231341),o=S(o,h,c,r,l[m+7],22,-45705983),r=S(r,o,h,c,l[m+8],7,1770035416),c=S(c,r,o,h,l[m+9],12,-1958414417),h=S(h,c,r,o,l[m+10],17,-42063),o=S(o,h,c,r,l[m+11],22,-1990404162),r=S(r,o,h,c,l[m+12],7,1804603682),c=S(c,r,o,h,l[m+13],12,-40341101),h=S(h,c,r,o,l[m+14],17,-1502002290),o=S(o,h,c,r,l[m+15],22,1236535329),r=y(r,o,h,c,l[m+1],5,-165796510),c=y(c,r,o,h,l[m+6],9,-1069501632),h=y(h,c,r,o,l[m+11],14,643717713),o=y(o,h,c,r,l[m+0],20,-373897302),r=y(r,o,h,c,l[m+5],5,-701558691),c=y(c,r,o,h,l[m+10],9,38016083),h=y(h,c,r,o,l[m+15],14,-660478335),o=y(o,h,c,r,l[m+4],20,-405537848),r=y(r,o,h,c,l[m+9],5,568446438),c=y(c,r,o,h,l[m+14],9,-1019803690),h=y(h,c,r,o,l[m+3],14,-187363961),o=y(o,h,c,r,l[m+8],20,1163531501),r=y(r,o,h,c,l[m+13],5,-1444681467),c=y(c,r,o,h,l[m+2],9,-51403784),h=y(h,c,r,o,l[m+7],14,1735328473),o=y(o,h,c,r,l[m+12],20,-1926607734),r=v(r,o,h,c,l[m+5],4,-378558),c=v(c,r,o,h,l[m+8],11,-2022574463),h=v(h,c,r,o,l[m+11],16,1839030562),o=v(o,h,c,r,l[m+14],23,-35309556),r=v(r,o,h,c,l[m+1],4,-1530992060),c=v(c,r,o,h,l[m+4],11,1272893353),h=v(h,c,r,o,l[m+7],16,-155497632),o=v(o,h,c,r,l[m+10],23,-1094730640),r=v(r,o,h,c,l[m+13],4,681279174),c=v(c,r,o,h,l[m+0],11,-358537222),h=v(h,c,r,o,l[m+3],16,-722521979),o=v(o,h,c,r,l[m+6],23,76029189),r=v(r,o,h,c,l[m+9],4,-640364487),c=v(c,r,o,h,l[m+12],11,-421815835),h=v(h,c,r,o,l[m+15],16,530742520),o=v(o,h,c,r,l[m+2],23,-995338651),r=p(r,o,h,c,l[m+0],6,-198630844),c=p(c,r,o,h,l[m+7],10,1126891415),h=p(h,c,r,o,l[m+14],15,-1416354905),o=p(o,h,c,r,l[m+5],21,-57434055),r=p(r,o,h,c,l[m+12],6,1700485571),c=p(c,r,o,h,l[m+3],10,-1894986606),h=p(h,c,r,o,l[m+10],15,-1051523),o=p(o,h,c,r,l[m+1],21,-2054922799),r=p(r,o,h,c,l[m+8],6,1873313359),c=p(c,r,o,h,l[m+15],10,-30611744),h=p(h,c,r,o,l[m+6],15,-1560198380),o=p(o,h,c,r,l[m+13],21,1309151649),r=p(r,o,h,c,l[m+4],6,-145523070),c=p(c,r,o,h,l[m+11],10,-1120210379),h=p(h,c,r,o,l[m+2],15,718787259),o=p(o,h,c,r,l[m+9],21,-343485551),r=R(r,j),o=R(o,A),h=R(h,B),c=R(c,x)}return[r,o,h,c]}(function T(l){const u=[];for(let r=0,o=8*l.length;r<o;r+=8)u[r>>5]|=(255&l.charCodeAt(r/8))<<r%32;return u}(l),8*l.length);switch(r){case q.Raw:return o;case q.Hex:return function I(l){const u="0123456789abcdef",r=[];for(let o=0,h=4*l.length;o<h;o++)r.push(u.charAt(l[o>>2]>>o%4*8+4&15)+u.charAt(l[o>>2]>>o%4*8&15));return r.join("")}(o);case q.String:return function P(l){const u=[];for(let r=0,o=32*l.length;r<o;r+=8)u.push(String.fromCharCode(l[r>>5]>>>r%32&255));return u.join("")}(o);case q.Base64:return function D(l){const o=[];for(let h=0,c=4*l.length;h<c;h+=3){const m=(l[h>>2]>>h%4*8&255)<<16|(l[h+1>>2]>>(h+1)%4*8&255)<<8|l[h+2>>2]>>(h+2)%4*8&255;for(let j=0;j<4;j++)o.push(8*h+6*j>32*l.length?"=":"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(m>>6*(3-j)&63))}return o.join("")}(o)}}}}]);